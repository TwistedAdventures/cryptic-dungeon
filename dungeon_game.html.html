<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Cryptic Dungeon</title>
    <style>
        body {
            background: linear-gradient(to bottom, #1a1a2e, #0f0f1e);
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 30, 50, 0.8);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
        }
        
        h1 {
            color: #9d4edd;
            text-align: center;
            text-shadow: 0 0 10px rgba(157, 78, 221, 0.5);
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #c77dff;
            font-size: 0.9em;
            margin-bottom: 30px;
        }
        
        #game-output {
            background: #0a0a15;
            padding: 20px;
            border-radius: 5px;
            min-height: 300px;
            margin-bottom: 20px;
            border: 2px solid #7b2cbf;
            line-height: 1.6;
        }
        
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        input {
            flex: 1;
            padding: 12px;
            background: #1a1a2e;
            border: 2px solid #7b2cbf;
            color: #e0e0e0;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
        }
        
        input:focus {
            outline: none;
            border-color: #9d4edd;
            box-shadow: 0 0 10px rgba(157, 78, 221, 0.3);
        }
        
        button {
            padding: 12px 25px;
            background: #7b2cbf;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #9d4edd;
            box-shadow: 0 0 15px rgba(157, 78, 221, 0.5);
        }
        
        .cipher {
            color: #ff6b6b;
            font-weight: bold;
            letter-spacing: 2px;
        }
        
        .success {
            color: #51cf66;
        }
        
        .warning {
            color: #ffd43b;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(123, 44, 191, 0.2);
            border-radius: 5px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            color: #c77dff;
            font-size: 0.8em;
        }
        
        .stat-value {
            color: #e0e0e0;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .command-hint {
            font-size: 0.85em;
            color: #8b8b8b;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è THE CRYPTIC DUNGEON ‚öîÔ∏è</h1>
        <div class="subtitle">A Text-Based Puzzle Adventure</div>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-label">LOCATION</div>
                <div class="stat-value" id="location">Entrance</div>
            </div>
            <div class="stat">
                <div class="stat-label">ITEMS</div>
                <div class="stat-value" id="items">0</div>
            </div>
            <div class="stat">
                <div class="stat-label">SECRETS</div>
                <div class="stat-value" id="secrets">0/8</div>
            </div>
        </div>
        
        <div id="game-output"></div>
        
        <div class="input-area">
            <input type="text" id="command-input" placeholder="Enter your command..." autocomplete="off">
            <button onclick="submitCommand()">Submit</button>
        </div>
        
        <div class="command-hint">
            üí° Try commands like: look, examine, use, take, go [direction], help
        </div>
    </div>

    <script>
        let gameState = {
            currentRoom: 'entrance',
            inventory: [],
            secretsFound: 0,
            flags: {},
            finalPassword: generateFinalPassword(),
            cluesReceived: [],
            dead: false
        };

        const rooms = {
            entrance: {
                name: 'Dungeon Entrance',
                description: 'You stand before a massive stone archway leading into darkness. Torches flicker on either side. Strange runes are carved into the archway. To the east, a shimmering portal glows with an otherworldly light. High above, you can see a stone platform with rope anchors bolted to the walls.',
                exits: { north: 'hall', east: 'fairy_entrance', up: 'star_platform' },
                items: ['torch', 'rope', 'old map'],
                cipher: 'ORZZH WKH UXQHV',
                cipherSolution: 'EXAMINE THE RUNES',
                cipherHint: 'Caesar cipher - shift of 3',
                examined: false,
                deathTriggers: {
                    'take runes': 'You attempt to pry the glowing runes from the archway. The moment your fingers touch them with intent to steal, arcane wards detonate. Searing magical energy incinerates your hands, then spreads up your arms. You scream as the spell consumes your entire body, reducing you to a pile of ash and charred bone fragments.',
                    'touch runes': 'Your fingers brush carelessly against the ancient runes. Dormant protective magic flares to life. Lightning arcs through your body, your skeleton visible through burning flesh as electricity courses through every nerve. The last thing you see is the runes glowing crimson before eternal darkness claims you.',
                    'touch archway': 'Your hand presses against the ancient stone archway. Dark energy pulses from the stone, draining your life force. You age rapidly - hair turning white, skin wrinkling, bones becoming brittle. In moments you become an ancient, withered corpse, crumbling to dust.',
                    'drink water': 'You cup your hands and drink from a small puddle near the entrance. Too late, you realize it\'s not water - it\'s liquified wraith essence. Your insides freeze solid as the undead liquid courses through your veins. You collapse, crystallized from within, your body shattering like glass on the stone floor.',
                    'sleep': 'Foolishly, you decide to rest at the dungeon entrance. As you drift off, shadow creatures emerge from the darkness. They feed on dreams. You wake screaming as they devour your memories, your personality, your very sense of self. Your body survives, but you are now an empty husk, drooling and mindless.',
                    'shout': 'You shout loudly into the dungeon depths, your voice echoing endlessly. Something ancient hears you. A bone-chilling howl answers from the darkness. A massive shadow beast bounds toward you with impossible speed. Before you can flee, it tears you limb from limb, leaving only scattered pieces.'
                }
            },
            fairy_entrance: {
                name: 'The Glimmering Threshold',
                description: 'You step through the shimmering portal into a realm of impossible beauty. Crystalline trees sing in harmonies that hurt to hear. A golden fairy hovers before you. "Welcome, brave adventurer! To proceed, you must prove your worth through THREE trials! Choose your path: northwest to the Garden of Tests, northeast to the Hall of Challenges, or southeast to the Fountain of Trials!"',
                exits: { west: 'entrance', northwest: 'fairy_garden', northeast: 'fairy_mirrors', southeast: 'fairy_fountain' },
                items: ['fairy coin'],
                deathTriggers: {}
            },
            fairy_garden: {
                name: 'The Garden of Silver Tests - Trial One',
                description: 'Beautiful silver flowers bloom here. A fairy appears. "To pass, you must answer my riddle: What walks on four legs in morning, two at noon, and three at evening?" There are three paths: north for "Human", south for "Time", east for "Death".',
                exits: { north: 'fairy_garden_2', south: 'fairy_garden_2', east: 'fairy_garden_2' },
                items: ['silver petal'],
                deathTriggers: {}
            },
            fairy_garden_2: {
                name: 'The Garden of Silver Tests - Trial Two',
                description: 'The fairy claps! "Correct! Or... was it? Anyway, second test! Pick the REAL flower!" Three flowers appear: a ruby rose, an emerald lily, and a sapphire daisy. Type "pick ruby", "pick emerald", or "pick sapphire".',
                exits: {},
                items: [],
                puzzle: 'Pick a flower',
                puzzleSolution: 'any',
                deathTriggers: {
                    'pick ruby': 'fake',
                    'pick emerald': 'fake', 
                    'pick sapphire': 'fake'
                },
                autoDeath: 'You reach for your chosen flower. The fairy erupts into mocking laughter. "OH YOU ABSOLUTE BUFFOON! You thought there was a RIGHT answer?! They\'re ALL FAKE!" The flowers reveal themselves to be carnivorous plants with teeth like needles. They lunge at you, wrapping around your limbs. "Did you REALLY think we\'d let you win?!" the fairy shrieks with glee. "Every adventurer who takes the WRONG PATH through the WRONG DOOR gets the SAME FATE!" Other fairies materialize, pointing and cackling. "This IDIOT thought they could solve fairy trials! Thought they could EARN safe passage! What a FOOL!" The flowers pull you into the earth. "You walked through the eastern portal! You went NORTHWEST! Two wrong turns that led you HERE!" Your body is slowly digested by the garden. "And now you\'ll fertilize our beautiful flowers, you gullible, simple-minded MORON!" The fairies dance around your sinking form. "The riddle? The flowers? All MEANINGLESS! We just wanted to watch you TRY! Watch you HOPE! And then watch you DIE!" As the earth swallows you, they compose a mocking song: "Here lies a fool who thought they\'d pass our test, who walked into our trap and failed like all the rest! They answered riddles, picked their flower true, not knowing that EVERYONE who comes here dies, including YOU!" Your last vision is the fairies laughing hysterically as the poisonous flowers dissolve your flesh. "Another trophy for our garden of FOOLS!" they cackle.'
            },
            fairy_mirrors: {
                name: 'The Hall of Infinite Challenges - Stage One',
                description: 'Mirrors stretch endlessly. A fairy appears. "To prove yourself worthy, you must collect THREE mirror shards! The first is behind the RED mirror, BLUE mirror, or GREEN mirror. Type \'break red\', \'break blue\', or \'break green\'."',
                exits: { south: 'fairy_mirrors_2' },
                items: [],
                deathTriggers: {
                    'break red': 'fake',
                    'break blue': 'fake',
                    'break green': 'fake'
                }
            },
            fairy_mirrors_2: {
                name: 'The Hall of Infinite Challenges - Stage Two',
                description: '"Excellent!" the fairy cheers. "You got a mirror shard! Now for the second challenge: solve this puzzle! If 1=3, 2=6, 3=9, then 4=? Type \'answer 12\', \'answer 15\', or \'answer 10\'."',
                exits: {},
                items: [],
                deathTriggers: {
                    'answer 12': 'fake',
                    'answer 15': 'fake',
                    'answer 10': 'fake'
                },
                autoDeath: 'You confidently give your answer. The fairy pauses... then EXPLODES with laughter. "OH MY STARS! YOU THOUGHT THIS WAS REAL?!" Your reflection steps OUT of every mirror surrounding you, all grinning maliciously. "This FOOL," your reflections say in unison, "actually believed they could WIN!" The fairy wipes tears of laughter. "Let me explain something, you COLOSSAL IDIOT: You went EAST at the entrance! WRONG! Then you went NORTHEAST! ALSO WRONG! Two wrong turns! And you thought you could PUZZLE your way out of death?!" Your reflections grab you from all sides. "We\'ve been collecting mirror shards? FALSE! Solving puzzles? MEANINGLESS! This whole thing was a PERFORMANCE!" The fairy narrates your humiliation: "They broke mirrors like an OBEDIENT DOG! They solved fake puzzles with SUCH CONFIDENCE! And ALL of it was just to make their death more EMBARRASSING!" Your reflections begin tearing pieces of you into the mirrors. "Every shard will hold a piece of your screaming soul!" one cackles. "You\'ll spend ETERNITY solving FAKE PUZZLES in mirror prison!" The fairies compose a cruel song: "Here lies a fool who played our game, who thought that skill could earn them fame! But every challenge, every test, was just to make their death the BEST!" Your consciousness is shattered across a thousand mirror shards, each one forcing you to solve pointless puzzles for eternity while fairies point and laugh. "What an EMBARRASSINGLY gullible death!" they shriek. "Died trying to win an UNWINNABLE GAME!"'
            },
            fairy_fountain: {
                name: 'The Fountain of Trials - Challenge One',
                description: 'A magnificent fountain bubbles with glowing water. A water fairy emerges. "Greetings, challenger! To earn passage, complete my THREE tests! First: throw in a coin and make a wish! You have: silver_coin, fairy_coin. Type \'throw silver_coin\' or \'throw fairy_coin\'."',
                exits: { north: 'fairy_fountain_2' },
                items: [],
                deathTriggers: {
                    'throw silver_coin': 'fake',
                    'throw fairy_coin': 'fake'
                }
            },
            fairy_fountain_2: {
                name: 'The Fountain of Trials - Challenge Two',
                description: 'The fountain glows brighter! "Wonderful choice!" the fairy says. "Second test: What is your heart\'s TRUE desire? Type \'wealth\', \'power\', or \'wisdom\'."',
                exits: { north: 'fairy_fountain_3' },
                items: [],
                deathTriggers: {
                    'wealth': 'fake',
                    'power': 'fake',
                    'wisdom': 'fake'
                }
            },
            fairy_fountain_3: {
                name: 'The Fountain of Trials - Final Test',
                description: '"How noble!" the fairy exclaims. "Final test: Drink from the fountain to seal your wish! Type \'drink\' when ready."',
                exits: {},
                items: [],
                deathTriggers: {},
                autoDeath: 'You drink from the glowing fountain. The liquid tastes like starlight and honey. Then your stomach IGNITES. The fairy\'s gentle face twists into a savage grin. "AHAHAHA! You ACTUALLY DRANK IT! You FOOL!" Other fairies emerge, pointing and screaming with laughter. "This IDIOT went SOUTHEAST! Made a wish! Told us their desires! And DRANK POISON!" The water fairy cackles: "Every single test was MEANINGLESS! The coin? Didn\'t matter! Your desires? We don\'t CARE! We just wanted to see how OBEDIENTLY you\'d walk to your death!" The poison burns through your organs. "You thought you were being TESTED! You thought you could EARN something! But this is FAIRY REALM, you IMBECILE! We don\'t REWARD mortals! We MOCK them!" The fairies dance around your convulsing body. "Let\'s review their PATHETIC choices!" one shrieks. "First, they went through the WRONG portal! Strike one! Then they went SOUTHEAST! Strike two! Then they PARTICIPATED in our fake trials like a TRAINED MONKEY! Strike three!" You vomit blood as the poison liquefies your insides. "And the BEST part," the water fairy gloats, "is that you CHOSE to drink! We didn\'t force you! You TRUSTED us!" They compose a mocking eulogy: "Here lies a trusting soul so pure and true, who wished and drank and died like all fools do! They thought that fairies granted hearts\' desires, when really we just set them on poison FIRES!" Your body dissolves into the fountain, becoming part of the trap for the next fool. The fairies add your skull to their collection, engraved with: "IDIOT #3,847 - Trusted Fairies." They will laugh about your gullibility for centuries.'
            },
            hall: {
                name: 'Grand Hall',
                description: 'A vast hall stretches before you. Pillars rise to a vaulted ceiling lost in shadow 100 feet above. To the east, a door bears a curious lock. To the west, another passage beckons. The floor is decorated with intricate tiles. A faint giggling echoes from the northwest.',
                exits: { south: 'entrance', east: 'library', west: 'armory', northwest: 'fairy_ballroom', southwest: 'forgotten_chamber' },
                items: ['broken compass', 'dusty journal', 'flare', 'ancient tablet'],
                flareLit: false,
                cipher: null, // Revealed when flare is used
                cipherSolution: 'STARHOLDS THEKEYS',
                cipherHint: 'Caesar cipher - shift of 3',
                puzzle: 'On the eastern door, you see three symbols: üúÇ (EARTH), üúÅ (AIR), üúÑ (WATER). Below them is a keypad with numbers 1-4.',
                puzzleSolution: '421',
                puzzleHint: 'Think about the natural order... but reversed',
                deathTriggers: {
                    'touch ceiling': 'You reach up and somehow manage to touch the vaulted ceiling high above. Your touch disturbs centuries of accumulated darkness. The shadows come alive, dropping down like thick tar, engulfing you completely. You suffocate slowly as the living darkness fills your lungs, nose, and mouth.',
                    'run': 'You break into a run across the hall. Your footfalls trigger pressure plates hidden beneath specific tiles. Spears shoot up from the floor, impaling you through the chest and abdomen. You hang suspended, choking on blood, as your life drains away onto the beautiful tilework below.',
                    'climb pillars': 'You attempt to scale one of the massive pillars. Halfway up, the ancient stone crumbles beneath your grip. You plummet to the marble floor below. The sickening crack of your spine echoes through the hall as you land. Paralyzed and broken, you slowly bleed out on the cold stone.',
                    'kick door': 'In frustration, you kick the locked eastern door. The mechanism triggers a trap - a concealed scythe swings horizontally from the wall, cleaving through your midsection. Your torso separates from your legs. You have a few agonizing seconds to comprehend your bisected state before death takes you.'
                }
            },
            fairy_ballroom: {
                name: 'The Eternal Dance',
                description: 'You enter a grand ballroom where translucent fairies waltz to music you can barely hear. One beckons to you invitingly.',
                exits: {},
                items: [],
                autoDeath: 'The fairy extends a delicate hand. "Dance with me, traveler!" she says in a voice like silver bells. Flattered, you take her hand. MISTAKE. Her grip turns to iron, and the music swells into a maddening tempo. "You ABSOLUTE BUFFOON!" she screeches, her face contorting into something monstrous. "Did you think we wanted your COMPANY? We wanted your BONES!" The other fairies stop their waltz and point at you, shrieking with laughter. "This fool took the wrong turn and now must DANCE FOREVER!" Your legs begin moving against your will, faster and faster, matching the impossible rhythm. "Look at this clumsy oaf!" they jeer. "Can\'t even dance properly! What a pathetic excuse for a mortal!" Your feet bleed as they spin and leap and twirl without rest. Days pass. Weeks. Your muscles tear, your bones crack, but you cannot stop dancing. "This is what happens to IDIOTS who trust fairies!" they sing in chorus. "This is what happens to FOOLS who go northwest!" The fairy queen appears, wearing a crown of finger bones. "Your predecessor danced for seventy years before his heart finally exploded," she says cheerfully. "Let\'s see if you can beat that record, you gullible, simple-minded, WORTHLESS little worm!" You dance and dance and dance, surrounded by mocking laughter, until your heart bursts in your chest. Even then, your corpse continues to jerk and spasm to the music, a puppet for their eternal amusement. "What an embarrassing death!" they cackle. "Danced to death like a FOOL!"'
            },
            library: {
                name: 'Ancient Library',
                description: 'Dusty tomes line the walls. A pedestal in the center holds an open book with glowing text. Against the western wall sits an ornate ancient box with intricate carvings and a prominent keyhole. The air smells of aged parchment and forgotten knowledge. A soft, ethereal glow emanates from the northeast.',
                exits: { west: 'hall', down: 'crypt', northeast: 'fairy_library' },
                items: ['ancient key', 'quill', 'blank scroll', 'ancient box'],
                ancientBoxLocked: true,
                cipher: 'NWARD SI EHT ROOLF REDNU',
                cipherSolution: 'TRAPDOOR UNDER THE FLOOR',
                cipherHint: 'Read it backwards',
                trapdoorOpen: false,
                deathTriggers: {
                    'touch walls': 'You run your hand along the library walls. The stone is covered in microscopic runes you didn\'t notice. They activate at your touch, casting a spell of eternal study. Your body petrifies as your mind is forced to read every book in the library simultaneously. You die screaming inside a stone prison, your consciousness trapped forever.',
                    'burn books': 'You set fire to the ancient tomes. The library itself seems to awaken in fury. The books fly from their shelves, pages sharp as razors, slicing into your flesh from all directions. You are literally read to death, your blood writing the final chapter of your foolishness across the floor.',
                    'tear pages': 'You rip pages from one of the books. Spectral guardians materialize - ghostly librarians with hollow eyes. They point accusatory fingers as your body begins to petrify. Your scream turns to stone in your throat as you become a statue, forever trapped in silent agony.',
                    'shout': 'You yell loudly in the sacred library. The sound echoes, disturbing the spirits of long-dead scholars. They manifest as screaming phantoms, overwhelming your mind with forbidden knowledge. Your brain can\'t handle the influx - it liquefies and pours from your ears and nose. You die drooling and convulsing.'
                }
            },
            chamber_of_wonders: {
                name: 'The Chamber of Wonders',
                description: 'You emerge into a breathtaking underground chamber filled with impossible beauty. Luminescent crystals grow from the ceiling, casting rainbow light across marble floors. Ancient artifacts float in stasis fields - a crown of starlight, a sword made of frozen moonbeams, a book whose pages turn themselves. At the center is a massive crystal obelisk covered in an incredibly complex cipher that seems to shift and writhe as you look at it.',
                exits: { up: 'library' },
                items: ['starlight shard', 'ethereal compass', 'void crystal', 'prismatic gem'],
                cipher: 'GUR TNGRJNL BS JBAQREF BCRAF JURA SVIR CEVFZF NYYVATGURER YVTUG NAQ FUNQBJ ORPBZR BAR',
                cipherSolution: 'THE GATEWAY OF WONDERS OPENS WHEN FIVE PRISMS ALIGN THE LIGHT AND SHADOW BECOME ONE',
                cipherHint: 'ROT13 cipher (Caesar shift of 13)',
                examined: false,
                deathTriggers: {
                    'touch obelisk': 'You reach out and touch the crystal obelisk. Instantly, your consciousness is ripped from your body and trapped inside the crystal matrix. You exist as pure awareness, screaming silently, watching your body collapse and decay while you remain imprisoned in crystalline eternal torment.',
                    'break crystal': 'You shatter one of the luminescent crystals. The chamber\'s delicate magical equilibrium collapses. Reality itself begins to fracture around you. You are torn apart at the molecular level as space-time unravels, experiencing every possible death simultaneously across infinite timelines.',
                    'take crown': 'You reach for the floating crown of starlight. The moment your fingers touch it, the stasis field collapses and the crown\'s true nature is revealed - it is made of condensed dying stars. The gravitational forces crush you into a singularity smaller than an atom.',
                    'read floating book': 'You open the self-turning book. It contains the True Name of Death itself. Speaking the name aloud, even in your mind, kills you instantly. Your soul is erased from existence - not dead, but unmade, as if you never were.'
                }
            },
            fairy_library: {
                name: 'The Library of Forgotten Names',
                description: 'Books float in mid-air, their pages turning themselves. A fairy librarian looks up from an ancient tome and smiles.',
                exits: {},
                items: [],
                autoDeath: 'The fairy closes her book with a soft thump. "Welcome, seeker of knowledge!" she says warmly. "Please, sign our guest book!" She presents an ornate book with a quill. The moment you write your name, the ink burns through the page and your name VANISHES from existence. "OH, HOW DELICIOUS!" the fairy shrieks, her form twisting into something grotesque. "You just erased yourself, you ABSOLUTE MORON!" Other fairies materialize from between the floating books, pointing and howling with laughter. "This IMBECILE just signed the Book of Unbeing! What kind of IDIOT signs mysterious books in FAIRY REALMS?" Your memories begin to fade. Your family forgets you. Your friends cannot recall your face. Every achievement, every relationship, every moment of your life is being UNMADE. "You\'re being deleted from reality, you fool!" the librarian cackles. "And the best part? You took the WRONG DIRECTION to get here! You didn\'t have to die like this! You could have gone ANY OTHER WAY!" The fairies mock you as you fade: "Here lies... wait, who? Oh right, NOBODY! Because they were too STUPID to read the warning signs!" As your existence unravels, the fairy librarian opens to a fresh page. "I\'ll keep this page blank," she says with mock sympathy, "as a memorial to the FOOL who went northeast when they should have gone west. May your non-existence serve as a lesson to... oh wait, no one will remember you existed!" You fade into nothing, not even a ghost, not even a memory, just a blank page in a book that no one will ever read. The fairies\' laughter echoes in the void where you used to be.'
            },
            armory: {
                name: 'Armory',
                description: 'Weapons and armor hang from the walls, all rusted and broken. A shield leans against the far wall with an inscription. Dust motes dance in the dim light. You hear tinkling laughter coming from the southwest.',
                exits: { east: 'hall', north: 'forge', southwest: 'fairy_forge' },
                items: ['rusty sword', 'tattered banner', 'iron nail'],
                cipher: '‚öîÔ∏è=S üõ°Ô∏è=H üèπ=I üëë=E ‚ö°=L üî•=D    ‚öîÔ∏èüõ°Ô∏èüèπüëë‚ö°üî•',
                cipherSolution: 'SHIELD',
                cipherHint: 'Symbol substitution - decode the symbols to spell the word',
                deathTriggers: {
                    'touch weapons': 'You reach out and touch one of the hanging weapons. It crumbles at your touch, releasing a cloud of crimson spores - weaponized rust plague. Your lungs fill with the infection. You cough blood as your insides oxidize and corrode. You drown in your own liquefying organs.',
                    'wear armor': 'You don the ancient armor, ignoring its decrepit state. The moment the cursed metal touches your skin, it begins to constrict. The armor crushes inward, compressing your ribcage, pulverizing your organs. You die screaming inside an iron coffin of your own making.',
                    'polish armor': 'You attempt to polish one of the armor pieces. The moment you touch it with cloth, the curse activates. The armor animates and attacks you, beating you to death with its own gauntlets. Your skull caves in under the relentless metal fists.',
                    'break shield': 'You shatter the ancient shield. It was not decoration - it was a seal. From the crack bursts forth a trapped demon, bound here for centuries. With newfound freedom, it expresses its gratitude by tearing your soul from your body and devouring it. Your corpse collapses, eyes empty and void.'
                }
            },
            fairy_forge: {
                name: 'The Weaponsmith\'s Deal',
                description: 'A magnificent forge burns with rainbow flames. A burly fairy smith hammers at an anvil, creating weapons of impossible beauty.',
                exits: {},
                items: [],
                autoDeath: 'The fairy smith looks up and grins broadly. "Ah! A warrior! I can forge you a blade of legend!" He shows you a sword that gleams with starlight. "Just one drop of your blood to seal the pact!" Eager for power, you prick your finger and let a drop fall on the blade. The sword DRINKS IT. "BAHAHA! YOU FELL FOR IT!" the smith roars, his jovial demeanor shattering. "This blade doesn\'t serve its wielder - it DEVOURS them!" The other fairies emerge from the shadows, tears of laughter streaming down their faces. "Another GREEDY FOOL who wanted power without earning it!" The sword begins pulling your blood into itself, drop by drop, then stream by stream. "NO NO NO, the best part," a fairy gasps between giggles, "is that you went SOUTHWEST! The wrong way ENTIRELY! You could have just gone NORTH to the real forge!" The smith hammers on his anvil mockingly. "I\'ve made a thousand blades from fools like you! Arrogant! Lazy! Taking shortcuts to power!" Your body shrivels as the blade drains you. "And when you\'re dead," the smith continues, "I\'ll melt down this blade and make NEW weapons to trick MORE idiots just like you! You\'re not special! You\'re not chosen! You\'re just another MORON who made the WRONG CHOICE!" The fairies compose a mocking song about your death: "Here lies a fool who went southwest, who wanted power more than rest, who bled himself for pretty steel, and died to be a fairy\'s meal!" You die a withered husk, your blood now part of a weapon that will trick the next greedy fool who makes your same mistake. The fairies hang your empty skin on the wall as a trophy and a warning that no one will heed.'
            },
            forge: {
                name: 'Forgotten Forge',
                description: 'The forge is cold and dark. Ancient tools scatter the floor. A stone tablet rests on the anvil. The air is thick with the ghost of old fires. Strange whispers seem to come from the southeast.',
                exits: { south: 'armory', southeast: 'fairy_smithy' },
                items: ['silver coin', 'rusty tongs', 'coal'],
                cipher: 'ZL NHYK JVSSLJ[PVU PZ JVTWSL[L. ^OH[ PZ [OL √ÑUHS ^VYK?',
                cipherSolution: 'MY CARD COLLECTION IS COMPLETE',
                cipherHint: 'Caesar cipher - shift of 7',
                deathTriggers: {
                    'touch forge': 'You place your hand on the cold forge. Residual heat magic stored for centuries activates. The forge superheats instantly to temperatures beyond imagination. Your hand fuses to the metal, then your entire body ignites. You burn from the inside out, your screams cut short as your lungs sear.',
                    'light forge': 'You attempt to rekindle the ancient forge. The first spark ignites trapped gas in the chimney. The explosion is instant and devastating. Your body is incinerated in a pillar of flame so intense that you are reduced to ash before you can even register pain. Only a shadow on the wall remains.',
                    'hammer anvil': 'You strike the anvil with a hammer. The sound resonates at a frequency that shatters bone. Your skeleton vibrates apart inside your body, reducing you to a bag of skin filled with bone fragments and pulverized organs. You collapse in on yourself like a deflated balloon.',
                    'drink molten metal': 'In a moment of insanity, you attempt to drink from a crucible of hardened metal, thinking it\'s water. You pry your mouth open and pour in mercury that was pooled at the bottom. The liquid metal burns through your throat and stomach. You die writhing as the mercury poisons your entire system.'
                }
            },
            fairy_smithy: {
                name: 'The Court of Broken Oaths',
                description: 'You enter a courtroom where fairy judges sit in high chairs, their faces stern and beautiful.',
                exits: {},
                items: [],
                autoDeath: 'The head judge slams her gavel. "We have been expecting you, oath-breaker!" You try to protest - you\'ve broken no oaths! "SILENCE!" she screams. "By entering this court, you have pledged to answer for EVERY promise you\'ve ever broken!" The other judges cackle. "Oh, this one is RIPE with betrayals!" They begin listing every small promise you\'ve ever failed to keep - every "I\'ll call you back" you forgot, every "I\'ll start tomorrow" you delayed, every "I promise" you couldn\'t fulfill. "This fool doesn\'t even remember half of them!" a judge shrieks gleefully. "That makes it WORSE!" For hours, they catalog your failures while fairy spectators throw rotten fruit at you. "And the MOST embarrassing part," the head judge says, standing, "is that you came here BY CHOICE! You went SOUTHEAST! Nobody forced you! You CHOSE to walk into our court of judgment!" The fairies in the gallery howl with laughter. "GUILTY!" the judges chant. "GUILTY OF STUPIDITY! GUILTY OF BROKEN PROMISES! GUILTY OF GOING THE WRONG WAY!" The sentence: you must fulfill EVERY promise you\'ve ever broken, simultaneously, right now. Your body tears itself apart trying to be in a thousand places at once, doing ten thousand things. "Watch them try!" the fairies cheer. "Watch them fail AGAIN!" You die fragmented, your consciousness shattered across countless broken oaths, never at peace, never whole. The judges add your name to the eternal record: "Fool #4,782 who went southeast and died embarrassingly." They frame your final scream and hang it on the wall.'
            },
            crypt: {
                name: 'Hidden Crypt',
                description: 'You descend into a crypt lit by ethereal blue light. Stone coffins line the walls. A massive door blocks the northern passage, covered in intricate locks. The floor is covered in a thick layer of shimmering dust. The dead rest here... or do they? Soft singing drifts from the east.',
                exits: { up: 'library', north: 'treasure', east: 'fairy_crypt' },
                items: ['crystal orb', 'bone key', 'holy water', 'star key', 'fairy dust'],
                coffinOpened: false,
                puzzle: 'The door has a complex mechanism. You need to enter the FINAL PASSWORD to unlock it. The inscription reads: "Only those who have gathered the eight sacred secrets may proceed."',
                requiresSecrets: 8,
                deathTriggers: {
                    'touch coffins': 'You run your hands along the stone coffins. They were warded against grave robbers. Death magic surges into your body, aging you rapidly. Your skin wrinkles and sags, your hair falls out, your teeth crumble. In seconds you age a hundred years, dying of extreme old age, a withered mummy in ancient clothes.',
                    'open coffins': 'You pry open one of the stone coffins. Inside lies a desiccated corpse... that suddenly opens its eyes. The vampire lunges with supernatural speed, fangs sinking into your throat. As your blood is drained, you feel yourself dying and being reborn as something unholy. But the transformation fails. You die in agony, stuck between life and undeath.',
                    'spit': 'You disrespectfully spit on the sacred ground. The spirits of the crypt awaken in fury. Spectral hands reach through the walls, grasping your soul. They pull the essence from your body, screaming and struggling. Your empty husk collapses as your consciousness is dragged into eternal torment with the restless dead.',
                    'dance': 'You mockingly dance among the tombs. The ground splits open beneath you, revealing a chasm to the underworld. You fall endlessly into darkness, surrounded by the wailing of damned souls. You fall forever, dying and reviving in an infinite loop of impact, each one as agonizing as the first.'
                }
            },
            tomb_of_trials: {
                name: 'The Tomb of Trials',
                description: 'You descend beneath the crypt into an ancient tomb chamber carved from obsidian. The walls are lined with skull-filled alcoves. Pressure plates cover the floor. Poisoned dart launchers are visible in the walls. Spectral flames burn in braziers, casting an eerie green light. At the far end is an altar with a massive stone tablet covered in an incredibly complex cipher that seems to be written in multiple languages overlaid on each other.',
                exits: { up: 'crypt' },
                items: ['cursed dagger', 'death mask', 'soul stone', 'ancient skull'],
                trapsActive: true,
                cipher: 'ZKDW LV GHDG PDB QHYHU GLH ZLWK VWUDQJH DHRQV HYHQ GHDWK PDB GLH',
                cipherSolution: 'WHAT IS DEAD MAY NEVER DIE WITH STRANGE AEONS EVEN DEATH MAY DIE',
                cipherHint: 'Multi-layer Caesar cipher with Vigen√®re - extremely difficult',
                examined: false,
                deathTriggers: {
                    'step on plate': 'You carelessly step on a pressure plate. A dozen poisoned darts fire from the walls, piercing your throat, chest, and eyes. The venom is instantaneous. Your nervous system shuts down and you collapse, paralyzed but conscious, as your organs slowly fail over the next five agonizing minutes.',
                    'touch skulls': 'You reach for one of the skulls in the alcoves. The moment you touch it, all the skulls begin screaming in unison - a chorus of the damned. The sound is so intense it liquefies your brain inside your skull. Blood pours from your eyes, ears, nose, and mouth as your gray matter runs out like soup.',
                    'disturb altar': 'You carelessly disturb the altar. The spectral flames explode into an inferno of soul-fire. The flames don\'t burn your body - they burn your SOUL. You remain alive but empty, a mindless husk that will wander the tomb forever, unable to die, unable to think, unable to escape.',
                    'kick brazier': 'You kick over one of the burning braziers. The spectral flames spread across the floor, seeking living flesh. The fire consumes you from the inside out, burning your organs while leaving your skin intact. You die screaming, smoke pouring from your mouth and eye sockets.',
                    'run': 'You try to run across the room. You trigger every single pressure plate at once. Hundreds of darts, spears, and blades fire from all directions, turning you into a pincushion. Your body is so full of projectiles that it remains standing upright even after you\'re dead.'
                }
            },
            fairy_crypt: {
                name: 'The Resurrection Chamber',
                description: 'Beautiful fairy mourners weep over an ornate casket. One looks up with tear-stained cheeks. "Please," she begs, "help us revive our fallen queen!"',
                exits: {},
                items: [],
                autoDeath: 'Moved by compassion, you approach the casket. The fairy mourner grasps your hand gratefully. "Just place your hand on her heart and transfer your life force!" You do. The "queen" in the casket opens her eyes and LAUGHS. "ANOTHER ONE!" she shrieks, sitting up. "Another BLEEDING HEART who fell for the crying act!" The "mourners" drop their sad act and start cackling hysterically. "This FOOL thought they were HELPING!" one wheezes. "Went EAST in the crypt! EAST! Who does that?!" The "queen" drains your life force, growing younger and more vibrant as you wither. "Do you know how many idiots we\'ve tricked this way?" she gloats. "Hundreds! Thousands! All because they couldn\'t resist playing HERO!" The fairies mock your nobility: "Oh look, a GOOD PERSON! How EMBARRASSING! Being good in a FAIRY REALM!" They dance around you as you age. "Should have been more SELFISH! Should have gone NORTH! Should have minded your own BUSINESS!" The queen absorbs the last of your life, looking radiant. "Thank you, you gullible, soft-hearted, STUPID little mortal! Your kindness was DELICIOUS!" She kisses your withered forehead mockingly. "Die knowing that your good deed just made me immortal for another century, and that I will use that time to trick MORE fools just like you!" The fairies compose an epitaph: "Here died compassion, here died trust, here died a fool who went east because they must. They thought they would be a hero brave and true, but heroes do not last long in fairy realms, it is true!" You die a desiccated husk, your kindness rewarded with mockery, your heroism with humiliation. The fairies turn your dried corpse into a scarecrow to guard their treasure, forever trapped in a pose of reaching out to help.'
            },
            treasure: {
                name: 'Treasure Chamber',
                description: 'You have reached the heart of the dungeon! Gold and jewels glitter in the torchlight. You have conquered the Cryptic Dungeon!',
                exits: {},
                items: ['crown'],
                victory: true,
                deathTriggers: {
                    'touch crown': 'You reach for the magnificent crown before properly examining it. The moment your fingers make contact, a curse activates. Thorns burst from inside the crown, impaling your skull from all angles. The crown fuses to your head as you die, forever wearing your prize in death.',
                    'grab everything': 'Your greed is your undoing. As you frantically grab armfuls of treasure, you trigger the final guardian. A massive stone golem animates, its eyes glowing red. It grabs you in one enormous hand and slowly crushes you. Your bones crack one by one as you scream. The golem drops your mangled corpse onto the pile of gold you died for.',
                    'swim in gold': 'You dive into the pile of treasure like a dragon. Unknown to you, the gold coins are cursed. They begin to melt and fuse to your skin. The molten gold covers your body, hardening as it cools. You become a golden statue, screaming and alive inside your metal tomb, unable to move or breathe for all eternity.'
                }
            },
            star_platform: {
                name: 'The Elevated Star Platform',
                description: 'A narrow stone platform high above the entrance hall. Ancient rope anchors are bolted to the walls. In the center sits an ornate star-shaped box covered in celestial symbols. The ceiling here has a massive opening showing the night sky above.',
                exits: { down: 'entrance' },
                items: ['star box'],
                examined: false,
                starBoxLocked: true,
                deathTriggers: {
                    'jump down': 'You leap from the platform, thinking you can land safely. The fall is too far. Your legs shatter on impact, bone fragments piercing through skin. You bleed out slowly, unable to move, staring up at the platform you foolishly jumped from.',
                    'lean over edge': 'You lean too far over the edge of the platform. The ancient stone crumbles beneath your weight. You plummet backward, your skull cracking open on the entrance floor far below. Blood pools around your broken body.'
                }
            },
            forgotten_chamber: {
                name: 'The Forgotten Chamber',
                description: 'A pitch-black room. You can see absolutely nothing without light. The air feels ancient and still. You sense something important here, but cannot see it.',
                descriptionLit: 'With the firepit blazing, ancient fairy script glows on the walls in ethereal blue light! The symbols shift and dance in the firelight, forming beautiful patterns. Three ornate levers protrude from the eastern wall, each carved with different fairy runes.',
                exits: { northeast: 'hall' },
                items: ['torch holder', 'old scroll', 'enchanted coal'],
                firepit: false,
                trapDoorOpen: false,
                examined: false,
                deathTriggers: {
                    'enter in dark': 'You stumble forward in total darkness and fall into a hidden pit filled with rusted spikes. Your body is impaled in multiple places. You die slowly in the dark, alone, your screams echoing in the blackness.',
                    'pull lever 1': 'You pull the first lever. A grinding sound fills the chamber. From the ceiling, massive iron spikes begin descending slowly. You realize too late there\'s no way to reverse it. The spikes impale you from above, piercing through your shoulders, chest, and skull. You die screaming, pinned to the floor like an insect.',
                    'pull lever 2': 'You pull the second lever. The walls suddenly lurch inward with a deafening grinding sound. Ancient mechanisms groan as the chamber begins compressing. You scramble but there\'s nowhere to go. The walls crush you slowly, bones snapping like dry twigs, organs rupturing, blood squeezing from every orifice. Your final breath is squeezed from your collapsing lungs.',
                    'pull lever1': 'You pull the first lever. A grinding sound fills the chamber. From the ceiling, massive iron spikes begin descending slowly. You realize too late there\'s no way to reverse it. The spikes impale you from above, piercing through your shoulders, chest, and skull. You die screaming, pinned to the floor like an insect.',
                    'pull lever2': 'You pull the second lever. The walls suddenly lurch inward with a deafening grinding sound. Ancient mechanisms groan as the chamber begins compressing. You scramble but there\'s nowhere to go. The walls crush you slowly, bones snapping like dry twigs, organs rupturing, blood squeezing from every orifice. Your final breath is squeezed from your collapsing lungs.'
                }
            },
            hidden_sanctum: {
                name: 'The Hidden Sanctum of the Fallen',
                description: 'A secret chamber revealed by the trap door! Ancient fairy architecture surrounds you - delicate stonework that seems to defy gravity. In the center lies a skeleton with magnificent wings that glow with soft purple light. The wings are still intact, shimmering with residual magic. Treasures are scattered around the chamber.',
                exits: { up: 'forgotten_chamber', west: 'secret_passage' },
                items: ['fairy wings', 'moonstone', 'crystal vial', 'rune stone', 'ancient compass'],
                cipher: 'ZLQJV JUDQW IOLJKW',
                cipherSolution: 'WINGS GRANT FLIGHT',
                cipherHint: 'Caesar cipher - shift of 3',
                examined: false,
                deathTriggers: {
                    'disturb skeleton': 'You carelessly disturb the fairy skeleton. Vengeful magic erupts from the bones. The skeleton\'s jaw unhinges and releases a curse of eternal silence. Your vocal cords dissolve. Your lungs fill with spectral moths that flutter and scratch. You choke to death on ethereal insects, unable to scream.',
                    'break wings': 'You attempt to break or damage the wings. The moment they\'re harmed, all fairy magic in the dungeon turns hostile. Invisible blades slice through you from every angle. You are cut into ribbons, your body falling apart in bloody sections.',
                    'kick skeleton': 'You kick the ancient fairy skeleton. It crumbles to dust, and immediately a terrible curse activates. Your bones begin to liquefy inside your body. You collapse as your skeleton turns to mush, leaving you as a bag of skin filled with bone soup.'
                }
            },
            secret_passage: {
                name: 'The Narrow Secret Passage',
                description: 'A cramped tunnel leading deeper underground. The walls are covered in more glowing fairy script. You can barely squeeze through. The passage slopes downward into darkness.',
                exits: { east: 'hidden_sanctum', north: 'ancient_vault' },
                items: ['glowing mushrooms'],
                examined: false,
                deathTriggers: {
                    'eat mushrooms': 'You eat the glowing mushrooms, thinking they might be magical. They are violently poisonous. Your throat swells shut as your body convulses. Foam pours from your mouth as every muscle seizes. You die from toxic shock, your body twitching.',
                    'lick mushrooms': 'You lick one of the glowing mushrooms. Even this small amount of toxin is deadly. Your tongue swells to three times its size, choking you. You claw at your throat but cannot breathe. You suffocate on your own enlarged tongue.'
                }
            },
            ancient_vault: {
                name: 'The Ancient Vault of Secrets',
                description: 'A massive underground vault with impossibly high ceilings - at least 50 feet up! On top of a smooth stone pillar in the center is a glowing orb pulsing with magical energy. There\'s no way to reach it by climbing... unless you could fly. The walls are carved with images of winged fairies soaring through the air.',
                exits: { south: 'secret_passage' },
                items: ['magic orb'],
                examined: false,
                deathTriggers: {
                    'jump for orb': 'You jump, trying to reach the orb 50 feet above. You don\'t even get close. Landing awkwardly, both ankles shatter. Bone fragments pierce through your skin. Unable to walk, you slowly starve to death in the vault, your broken legs useless.',
                    'climb pillar': 'You attempt to climb the smooth pillar. It\'s been magically treated to be completely frictionless. You slide down immediately and crack your head open on the stone floor. Your skull splits like an egg.',
                    'stack items': 'You try to stack items to climb higher. The makeshift tower collapses, and you fall head-first onto the stone. Your neck snaps on impact. You die instantly.'
                }
            }
        };

        function generateFinalPassword() {
            const passwordData = {
                'DRAGON': {
                    clues: [
                        'The wyrm sleeps upon its hoard of letters, six in total, guarding fire.',
                        'When the serpent eats its tail, six remain standing in the circle.',
                        'The beast that never was, yet always is, speaks its name in silence.',
                        'Fire becomes ash becomes earth becomes treasure. The cycle has a name.',
                        'In the language of beasts and flames, what word holds six burning scales?'
                    ]
                },
                'SHADOW': {
                    clues: [
                        'Light creates me, darkness hides me, yet I am neither. Six steps away.',
                        'The twin that walks behind you always, counting its silent footsteps.',
                        'What the sundial knows but the night denies, in six silent breaths.',
                        'The philosopher saw it on the cave wall. What was its name?',
                        'Between the candle and the void, something lingers in six parts.'
                    ]
                },
                'MYSTIC': {
                    clues: [
                        'The seer speaks through mist and fog, in six syllables of mystery.',
                        'Between the known and unknown, a walker dwells in mist. Six syllables.',
                        'What the oracle becomes when stripped of clarity and doubt.',
                        'The fog has a name. It whispers in six ancient tongues.',
                        'Neither here nor there, but everywhere between. Count to six.'
                    ]
                },
                'ANCIENT': {
                    clues: [
                        'Before the before, seven echoes remain in forgotten stone.',
                        'Time devours all but leaves this word behind. Seven fragments.',
                        'The opposite walks backward through seven doors of forgetting.',
                        'What yesterday was to tomorrow, in seven falling leaves.',
                        'The stones remember, but the word is older. Seven letters deep.'
                    ]
                },
                'PHOENIX': {
                    clues: [
                        'Death is birth is death. The cycle whispers its eternal name.',
                        'From zero to infinity, the bird counts seven feathers of flame.',
                        'Ashes remember what they were. Seven parts of resurrection.',
                        'The firebird that cannot die speaks its true name once.',
                        'In the language of renewal: seven letters, infinite lives.'
                    ]
                },
                'CRYSTAL': {
                    clues: [
                        'The seer\'s tool reveals its nature through seven transparent facets.',
                        'Clarity has a name with seven transparent faces.',
                        'What the earth births in perfect geometry, spoken in seven.',
                        'The lattice knows its own structure. Seven points of light.',
                        'Between chaos and order, something pure emerges. Count seven.'
                    ]
                },
                'EMBER': {
                    clues: [
                        'The dying flame remembers its five fading parts before darkness.',
                        'Neither alive nor dead, five glowing memories persist.',
                        'The hearth holds its secret in five cooling breaths.',
                        'What December guards at its end, in five fading parts.',
                        'The last warmth before the cold. Five letters of twilight.'
                    ]
                },
                'RAVEN': {
                    clues: [
                        'The dark messenger spreads five wings across the sky.',
                        'Nevermore speaks through five letters of shadow.',
                        'The corvid that knows too much has a five-letter name.',
                        'In the tower, what watches with eyes of night? Five feathers.',
                        'The bird of omens speaks its name once. Five dark syllables.'
                    ]
                }
            };
            
            const words = Object.keys(passwordData);
            const chosen = words[Math.floor(Math.random() * words.length)];
            return { word: chosen, clues: passwordData[chosen].clues };
        }

        function displayMessage(text, className = '') {
            const output = document.getElementById('game-output');
            const message = document.createElement('div');
            message.className = className;
            message.innerHTML = text;
            output.appendChild(message);
            output.scrollTop = output.scrollHeight;
        }

        function updateStats() {
            document.getElementById('location').textContent = rooms[gameState.currentRoom].name;
            document.getElementById('items').textContent = gameState.inventory.length;
            document.getElementById('secrets').textContent = `${gameState.secretsFound}/8`;
        }

        function describeRoom() {
            const room = rooms[gameState.currentRoom];
            displayMessage(`<br><strong>üìç ${room.name}</strong>`, 'warning');
            
            // Special handling for Forgotten Chamber - show different description when lit
            if (gameState.currentRoom === 'forgotten_chamber' && gameState.flags.firepitLit && room.descriptionLit) {
                displayMessage(room.descriptionLit);
            } else {
                displayMessage(room.description);
            }
            
            if (room.items && room.items.length > 0) {
                displayMessage(`<br>You see: ${room.items.join(', ')}`);
            }
            
            if (room.cipher && !gameState.flags[`${gameState.currentRoom}_cipher_solved`]) {
                displayMessage(`<br><span class="cipher">${room.cipher}</span>`);
            }
            
            if (room.puzzle && !gameState.flags[`${gameState.currentRoom}_puzzle_solved`]) {
                displayMessage(`<br>${room.puzzle}`, 'warning');
            }
            
            const exits = Object.keys(room.exits);
            if (exits.length > 0) {
                displayMessage(`<br>Exits: ${exits.join(', ')}`);
            }
            
            // Show DOWN exit if trap door is open in Forgotten Chamber
            if (gameState.currentRoom === 'forgotten_chamber' && gameState.flags.trapDoorOpen) {
                displayMessage(`<br>Exits: northeast, down`);
            }
            
            if (room.victory) {
                displayMessage(`<br><span class="success">üéâ CONGRATULATIONS! You have completed the dungeon! üéâ</span>`);
                displayMessage(`<br>Type 'restart' to play again with a new password!`);
            }
        }

        function processCommand(input) {
            const parts = input.toLowerCase().trim().split(' ');
            const command = parts[0];
            const args = parts.slice(1).join(' ');
            const room = rooms[gameState.currentRoom];

            // Check for death triggers - must match exact command patterns
            if (room.deathTriggers) {
                const fullCommand = input.toLowerCase().trim();
                for (let trigger in room.deathTriggers) {
                    // Check if the full command matches the trigger pattern
                    // Avoid false positives like "examine runes" triggering "touch runes"
                    if (fullCommand === trigger || 
                        (fullCommand.startsWith(trigger.split(' ')[0] + ' ') && 
                         fullCommand.includes(trigger))) {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ DEATH üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage(`<br>${room.deathTriggers[trigger]}`);
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. Your adventure ends here in darkness and pain.</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                }
            }

            // Prevent actions if dead
            if (gameState.dead && command !== 'restart') {
                displayMessage('You are dead. Type "restart" to begin anew.');
                return;
            }

            if (command === 'restart') {
                // Reset rooms to original state with items
                rooms.entrance.items = ['torch', 'rope', 'old map'];
                rooms.hall.items = ['broken compass', 'dusty journal', 'flare', 'ancient tablet'];
                rooms.library.items = ['ancient key', 'quill', 'blank scroll', 'ancient box'];
                rooms.chamber_of_wonders.items = ['starlight shard', 'ethereal compass', 'void crystal', 'prismatic gem'];
                rooms.armory.items = ['rusty sword', 'tattered banner', 'iron nail'];
                rooms.forge.items = ['silver coin', 'rusty tongs', 'coal'];
                rooms.crypt.items = ['crystal orb', 'bone key', 'holy water', 'star key', 'fairy dust'];
                rooms.tomb_of_trials.items = ['cursed dagger', 'death mask', 'soul stone', 'ancient skull'];
                rooms.treasure.items = ['crown'];
                rooms.star_platform.items = ['star box'];
                rooms.forgotten_chamber.items = ['torch holder', 'old scroll', 'enchanted coal'];
                rooms.hidden_sanctum.items = ['fairy wings', 'moonstone', 'crystal vial', 'rune stone', 'ancient compass'];
                rooms.secret_passage.items = ['glowing mushrooms'];
                rooms.ancient_vault.items = ['magic orb'];
                
                gameState = {
                    currentRoom: 'entrance',
                    inventory: [],
                    secretsFound: 0,
                    flags: {},
                    finalPassword: generateFinalPassword(),
                    cluesReceived: [],
                    dead: false
                };
                document.getElementById('game-output').innerHTML = '';
                displayMessage('üîÑ Game restarted! A new adventure awaits with a new password...', 'success');
                displayMessage('üíÄ Be careful - death lurks in every shadow...');
                describeRoom();
                updateStats();
                return;
            }

            if (command === 'help') {
                displayMessage('<br><strong>Available Commands:</strong>');
                displayMessage('‚Ä¢ look - examine your surroundings');
                displayMessage('‚Ä¢ examine [thing] - look closely at something');
                displayMessage('‚Ä¢ take [item] - pick up an item');
                displayMessage('‚Ä¢ take all - pick up everything in the room');
                displayMessage('‚Ä¢ leave [item] / drop [item] - leave an item in the current room');
                displayMessage('‚Ä¢ use [item] - use an item from your inventory');
                displayMessage('‚Ä¢ wear [item] - wear an item (if possible)');
                displayMessage('‚Ä¢ fight [enemy] - attack an enemy with your equipped weapon');
                displayMessage('‚Ä¢ go [direction] - move in a direction (north, south, east, west, up, down, northeast, northwest, etc.)');
                displayMessage('‚Ä¢ inventory - check what you\'re carrying');
                displayMessage('‚Ä¢ solve [answer] - attempt to solve a cipher or puzzle');
                displayMessage('‚Ä¢ say [words] - speak aloud (be careful what you say...)');
                displayMessage('‚Ä¢ open [thing] - try to open something');
                displayMessage('‚Ä¢ close [thing] - try to close something');
                displayMessage('‚Ä¢ touch [thing] - touch something');
                displayMessage('‚Ä¢ break [thing] - try to break something');
                displayMessage('‚Ä¢ burn [thing] - try to burn something');
                displayMessage('‚Ä¢ light [thing] - try to light something on fire');
                displayMessage('‚Ä¢ pull [thing] - pull a lever or similar');
                displayMessage('‚Ä¢ fly - use wings to fly (if equipped)');
                displayMessage('‚Ä¢ steal [thing] - try to steal something');
                displayMessage('‚Ä¢ desecrate - desecrate something');
                displayMessage('‚Ä¢ disturb [thing] - disturb something');
                displayMessage('‚Ä¢ restart - start a new game');
                return;
            }

            // Handle fairy maze fake challenges
            if (command === 'pick' || command === 'break' || command === 'answer' || command === 'throw' || command === 'drink' || command === 'wealth' || command === 'power' || command === 'wisdom') {
                if (gameState.currentRoom === 'fairy_garden' && (args === 'ruby' || args === 'emerald' || args === 'sapphire' || command === 'pick')) {
                    gameState.currentRoom = 'fairy_garden_2';
                    displayMessage('<br>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                    describeRoom();
                    updateStats();
                    return;
                }
                
                if (gameState.currentRoom === 'fairy_mirrors' && command === 'break') {
                    displayMessage('"Perfect!" the fairy says gleefully. "You got a shard! Proceed south!"', 'success');
                    return;
                }
                
                if (gameState.currentRoom === 'fairy_fountain' && command === 'throw') {
                    displayMessage('"Your wish is noted!" the fairy says warmly. "Proceed north!"', 'success');
                    return;
                }
                
                if (gameState.currentRoom === 'fairy_fountain_2' && (command === 'wealth' || command === 'power' || command === 'wisdom' || args === 'wealth' || args === 'power' || args === 'wisdom')) {
                    displayMessage('"Admirable!" the fairy smiles. "Proceed north for the final test!"', 'success');
                    return;
                }
                
                if (gameState.currentRoom === 'fairy_fountain_3' && command === 'drink') {
                    setTimeout(() => {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ DEATH üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage(`<br>${rooms[gameState.currentRoom].autoDeath}`);
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. The fairies laugh at your foolishness.</span>');
                        displayMessage('<br>Type "restart" to try again, if you dare face their mockery once more...');
                        gameState.dead = true;
                    }, 1000);
                    return;
                }
            }

            if (command === 'look') {
                describeRoom();
                return;
            }
            
            // LEAVE or DROP command - drop an item in current room
            if (command === 'leave' || command === 'drop') {
                const itemName = args.toLowerCase().replace(/ /g, '');
                const item = gameState.inventory.find(i => i.toLowerCase().replace(/ /g, '') === itemName);
                
                if (!item) {
                    displayMessage('You don\'t have that item to leave.');
                    return;
                }
                
                gameState.inventory = gameState.inventory.filter(i => i !== item);
                rooms[gameState.currentRoom].items.push(item);
                displayMessage(`You leave the ${item} here.`, 'success');
                updateStats();
                return;
            }

            if (command === 'inventory') {
                if (gameState.inventory.length === 0) {
                    displayMessage('Your inventory is empty.');
                } else {
                    displayMessage(`You are carrying: ${gameState.inventory.join(', ')}`);
                }
                return;
            }

            if (command === 'examine') {
                if (args === 'runes' && gameState.currentRoom === 'entrance') {
                    displayMessage('The runes glow faintly. They seem to be a message in code...');
                    displayMessage(`Hint: ${room.cipherHint}`, 'warning');
                } else if (args === 'book' && gameState.currentRoom === 'library') {
                    displayMessage('The glowing text appears to be written in reverse...');
                    displayMessage(`Hint: ${room.cipherHint}`, 'warning');
                } else if (args === 'shield' && gameState.currentRoom === 'armory') {
                    displayMessage('The shield has strange symbols etched into it with a pattern below...');
                    displayMessage(`Hint: ${room.cipherHint}`, 'warning');
                } else if (args === 'tablet' && gameState.currentRoom === 'forge') {
                    displayMessage('The tablet has text carved in an unfamiliar script...');
                } else if (args === 'coffins' && gameState.currentRoom === 'crypt') {
                    displayMessage('You approach the stone coffins lining the walls. Each one bears an epitaph carved into its lid:', 'warning');
                    displayMessage('<br>COFFIN 1: "Here lies MALACHAR THE VILE. Spoke the forbidden tongue. His words brought ruin. Speak his name and join his curse."');
                    displayMessage('<br>COFFIN 2: "SERAPHINE OF ENDLESS SORROW rests within. Betrayed all who loved her. Her name carries her betrayal. Speak it at your peril."');
                    displayMessage('<br>COFFIN 3: "VORTIGERN THE FLESH-EATER. Consumed his own kin. His hunger never died. Speak his name and become his feast."');
                    displayMessage('<br>COFFIN 4: "ISOLDE THE WITCH-QUEEN. Burned a thousand souls. Her flames still hunger. Utter her name and burn eternal."');
                    displayMessage('<br>COFFIN 5: "BARTHOLOMEW THE MAD. Lost his mind to the void. The void consumed him wholly. Speak his name and lose yourself."');
                    displayMessage('<br><span class="cipher">WARNING: Do not speak the names of the dead. Their curses are bound to their names. To speak is to invoke.</span>');
                } 
                // Examine items in inventory
                else if (gameState.inventory.some(i => i.replace(/ /g, '') === args.replace(/ /g, ''))) {
                    const item = gameState.inventory.find(i => i.replace(/ /g, '') === args.replace(/ /g, ''));
                    
                    if (item === 'torch') {
                        displayMessage('A sturdy wooden torch wrapped in oil-soaked cloth. Still burning. This provides light in dark places. Essential for entering the hall safely.', 'success');
                    } else if (item === 'rope') {
                        displayMessage('A coiled length of strong rope. Could be useful for climbing or tying things. Try using it in the hall.', 'success');
                    } else if (item === 'old map') {
                        displayMessage('An ancient parchment map of the dungeon. There appears to be a message written on it. Try using it to read the warning.', 'warning');
                    } else if (item === 'broken compass') {
                        displayMessage('A compass with a wildly spinning needle. Something feels wrong about it. The metal hums with strange energy.', 'warning');
                    } else if (item === 'dusty journal') {
                        displayMessage('A leather-bound journal covered in dust. The pages are filled with previous adventurer\'s notes. Use it to read their final entries.', 'success');
                    } else if (item === 'ancient key') {
                        displayMessage('An ornate key made of tarnished silver. It looks important but you haven\'t found what it unlocks yet. Try using it in the crypt.', 'success');
                    } else if (item === 'quill') {
                        displayMessage('A long black quill that seems to write on air. Handle with care - it must ONLY be used in the library. Using it elsewhere could be fatal.', 'warning');
                    } else if (item === 'blank scroll') {
                        displayMessage('A perfectly blank scroll. Good for taking notes about the clues you discover. Completely harmless to use.', 'success');
                    } else if (item === 'rusty sword') {
                        displayMessage('A heavily rusted sword. The rust seems... wrong. Almost alive. The blade is brittle and covered in reddish spores.', 'warning');
                    } else if (item === 'tattered banner') {
                        displayMessage('An old banner with a faded coat of arms. Torn and weathered but harmless. Using it won\'t do much.', 'success');
                    } else if (item === 'iron nail') {
                        displayMessage('A solid iron nail. Iron is known to repel evil spirits and supernatural creatures. This could be useful in the crypt.', 'success');
                    } else if (item === 'silver coin') {
                        displayMessage('A silver coin that glints in the light. It feels cold - too cold. There\'s an inscription you can\'t read. Something about this coin feels cursed. Using it might summon something terrible.', 'warning');
                    } else if (item === 'rusty tongs') {
                        displayMessage('Old blacksmith tongs, rusty but functional. Good for handling hot objects. Completely safe to use.', 'success');
                    } else if (item === 'coal') {
                        displayMessage('A piece of coal that seems darker than normal coal should be. It feels warm to the touch. Almost too warm.', 'warning');
                    } else if (item === 'crystal orb') {
                        displayMessage('A crystal sphere filled with swirling mist. Looking into it might reveal visions. Safe to use.', 'success');
                    } else if (item === 'bone key') {
                        displayMessage('A key carved from human bone. Macabre but potentially useful. Try using it in the crypt - there might be a bone-shaped lock somewhere.', 'success');
                    } else if (item === 'holy water') {
                        displayMessage('A vial of blessed water that glows faintly. This can protect against undead and evil spirits. Use it in the crypt for protection.', 'success');
                    } else if (item === 'crown') {
                        displayMessage('A magnificent crown encrusted with jewels. Beautiful and ornate. The inner band has small thorns. DO NOT wear this until you\'re safely in the treasure room. Using it elsewhere will be fatal.', 'warning');
                    } else if (item === 'fairy coin') {
                        displayMessage('A shimmering coin that appeared in the fairy realm. It feels strange and otherworldly. Probably useless... or cursed.', 'warning');
                    } else if (item === 'silver petal') {
                        displayMessage('A metallic flower petal from the fairy garden. Pretty but ultimately useless. A souvenir from a deadly place.', 'success');
                    } else {
                        displayMessage(`You examine the ${args}. Nothing special stands out.`);
                    }
                } else {
                    displayMessage(`You don't see anything special about that.`);
                }
                return;
            }

            if (command === 'use') {
                const itemName = args.toLowerCase().replace(/ /g, '');
                const item = gameState.inventory.find(i => i.replace(/ /g, '') === itemName);
                
                if (!item) {
                    displayMessage('You don\'t have that item.');
                    return;
                }
                
                // Torch - provides light (already required for hall)
                if (item === 'torch') {
                    displayMessage('The torch flickers, casting dancing shadows on the walls. Its light keeps the darkness at bay.');
                    return;
                }
                
                // Rope - can be used to climb safely from hall pillars
                if (item === 'rope' && gameState.currentRoom === 'hall') {
                    displayMessage('You tie the rope securely to a pillar. You can now climb safely! However, there\'s nothing up there except dust and disappointment.');
                    return;
                }
                
                if (item === 'rope' && gameState.currentRoom !== 'hall') {
                    displayMessage('There\'s nothing here to use the rope on.');
                    return;
                }
                
                // Old map - reveals a hint about the dungeon
                if (item === 'old map') {
                    displayMessage('You unfold the ancient map. It shows the dungeon layout, but there\'s a warning scrawled in blood: "CHOOSE WISELY FOR NOT ALL PATHS LEAD TO VICTORY. NORTH SOUTH EAST OR WEST, ONE WILL SURELY RISE IN DEATH."', 'warning');
                    return;
                }
                
                // Broken compass - DEATH TRAP
                if (item === 'broken compass') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You open the broken compass. The needle spins wildly, faster and faster, creating a vortex of magnetic energy. The compass was cursed! It pulls all the iron in your blood toward it, ripping the hemoglobin from your veins. Your blood literally flies out of your body through your pores, drawn to the spinning needle. You collapse as a withered, bloodless husk. The compass clatters to the ground, now coated in your blood, ready to kill the next fool who tries to use it.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Some items are cursed.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Dusty journal - provides a clue
                if (item === 'dusty journal') {
                    displayMessage('You read the journal. The last entry reads: "Day 47: I\'ve solved four ciphers. One more remains in the forge. The final password changes with each attempt. May fortune favor the next adventurer."');
                    return;
                }
                
                // Ancient key - opens the ancient box in the library!
                if (item === 'ancient key' && gameState.currentRoom === 'library') {
                    if (rooms.library.items.includes('ancient box')) {
                        displayMessage('You insert the ancient key into the ornate box. It fits perfectly!', 'success');
                        displayMessage('<br>As you turn the key, intricate mechanisms click and whir inside the box. The lid slowly opens with a melodious chime...', 'success');
                        displayMessage('<br>Inside the box, instead of treasures, you find a TRAPDOOR built into the bottom!', 'cipher');
                        displayMessage('<br>Stone steps lead down into a passage glowing with rainbow light.', 'success');
                        displayMessage('<br><span class="success">A path DOWN has been revealed inside the ancient box!</span>', 'success');
                        gameState.flags.ancientBoxOpened = true;
                        rooms.library.exits.down = 'chamber_of_wonders';
                        gameState.secretsFound++;
                        updateStats();
                    } else {
                        displayMessage('The ancient box has already been opened.');
                    }
                    return;
                }
                
                if (item === 'ancient key' && gameState.currentRoom === 'crypt') {
                    displayMessage('You try the ancient key on the massive door, but it doesn\'t fit. This key must be for something else... perhaps a box?');
                    return;
                }
                
                if (item === 'ancient key') {
                    displayMessage('The key is ornate and ancient. It looks like it would fit a decorative box rather than a door.');
                    return;
                }
                
                // Quill - DEATH TRAP if used in wrong room
                if (item === 'quill' && gameState.currentRoom !== 'library') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You attempt to write with the quill in the air. The moment the tip moves, ghostly words appear: "THIS QUILL MUST ONLY BE USED IN THE LIBRARY." Too late. The quill transforms into a writhing serpent that strikes your hand. Its venom is instantaneous and agonizing. Your body convulses as the poison spreads, liquefying your organs from the inside. You die choking on your own dissolving lungs. The quill reforms on the ground, waiting for the next person stupid enough to use it outside the library.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Read the instructions.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (item === 'quill' && gameState.currentRoom === 'library') {
                    if (!gameState.flags.quillUsed) {
                        gameState.flags.quillUsed = true;
                        displayMessage('You dip the quill in invisible ink and write on the air. As you move it, glowing letters appear, forming words that shimmer with ethereal light!', 'success');
                        displayMessage('<br>The magical script reads:', 'cipher');
                        displayMessage('<br><span class="cipher">WKH TXLOO ZULWHV WUXWK LQ OLJKW</span>', 'cipher');
                        displayMessage('<br>The words pulse with energy for a moment, then slowly fade into nothingness. But you saw the message.', 'warning');
                    } else {
                        displayMessage('You write with the quill again, but this time only faint glimmers appear. The magic seems to work only once.');
                    }
                    return;
                }
                
                // Blank scroll - can write clues on it
                if (item === 'blank scroll') {
                    displayMessage('The scroll unfurls. It\'s completely blank, perfect for taking notes. You could write down the clues you receive...');
                    return;
                }
                
                // Rusty sword - DEATH TRAP
                if (item === 'rusty sword') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You swing the rusty sword experimentally. The blade shatters on the first swing, sending shrapnel into your face and throat. But worse - the rust was actually weaponized plague spores. They enter your bloodstream through the wounds. Your body begins to corrode from within. Your organs rust like metal, your blood turns to orange sludge. You die screaming as your entire body oxidizes, transforming into a pile of rust-colored dust.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Don\'t use rusty weapons.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Tattered banner - can be used as cloth
                if (item === 'tattered banner') {
                    displayMessage('You wave the tattered banner. It\'s old and torn, but still bears the emblem of a forgotten kingdom. Might be worth something to a historian, but not useful here.');
                    return;
                }
                
                // Iron nail - useful in crypt
                if (item === 'iron nail' && gameState.currentRoom === 'crypt') {
                    displayMessage('You drive the iron nail into the ground. Iron repels evil spirits! You feel slightly safer here... though it won\'t save you from the bigger threats.', 'success');
                    return;
                }
                
                if (item === 'iron nail') {
                    displayMessage('The iron nail is solid and sharp. It might be useful for warding off evil... if you were in the right place.');
                    return;
                }
                
                // Silver coin - DEATH TRAP
                if (item === 'silver coin') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You flip the silver coin. It spins in the air, glinting in the light. When it lands, it doesn\'t stop spinning. Faster and faster it whirls, creating a portal. From the portal emerges the original owner of the coin - a lich who buried it with his treasure. "YOU DARE USE MY COIN?" it shrieks. The lich grabs you with skeletal hands and drags you into the portal, into its realm of eternal suffering. You are trapped in a dimension of undeath, neither alive nor dead, screaming forever in the void between worlds. The coin stops spinning and falls silent, ready to doom its next user.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Cursed coins bring death.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Rusty tongs - safe to use
                if (item === 'rusty tongs') {
                    displayMessage('You open and close the rusty tongs. They creak with age but still function. Good for picking up hot objects... if there were any.');
                    return;
                }
                
                // Coal - DEATH TRAP
                if (item === 'coal') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You examine the coal closely, bringing it near your face. Suddenly it IGNITES with hellfire! This is no ordinary coal - it\'s compressed demon essence. The flames are supernaturally hot, burning at temperatures that shouldn\'t exist. Your face melts like wax, your eyes boil in their sockets. The fire spreads to your hair, your clothes, your entire body. You run screaming but the hellfire cannot be extinguished. You burn alive for what feels like hours before finally collapsing as a charred skeleton. The coal reforms, waiting patiently for its next victim.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Some fuel is cursed.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Crystal orb - reveals hint
                if (item === 'crystal orb') {
                    if (gameState.currentRoom === 'hidden_sanctum') {
                        displayMessage('You hold the crystal orb aloft in the Hidden Sanctum. It begins to glow intensely!', 'success');
                        displayMessage('<br>The orb reveals HIDDEN MAGIC in the room! The fairy skeleton\'s wings pulse brighter, showing they are safe to take!', 'cipher');
                        displayMessage('<br>The walls shimmer, revealing secret passages and protections. You feel safer here.', 'success');
                        gameState.flags.orbUsedInSanctum = true;
                        return;
                    } else if (gameState.currentRoom === 'chamber_of_wonders') {
                        displayMessage('The crystal orb resonates with the chamber\'s magic! It shows you which artifacts are safe to take!', 'success');
                        displayMessage('<br>The floating crown, sword, and book are DEADLY. The items on the ground are safe!', 'warning');
                        return;
                    } else {
                        displayMessage('You gaze into the crystal orb. Misty visions swirl within...', 'warning');
                        displayMessage('<br>You see yourself standing in this very crypt, collecting secrets one by one...');
                        displayMessage('<br>You see a massive door covered in locks, waiting for a password...');
                        displayMessage('<br>You see eight words floating in the mist: DRAGON... SHADOW... MYSTIC... ANCIENT... PHOENIX... CRYSTAL... EMBER... RAVEN...');
                        displayMessage('<br>One of these words glows brighter than the others, but you cannot tell which...');
                        displayMessage('<br>The vision fades. The orb has shown you the path, but the final answer remains hidden.', 'success');
                        return;
                    }
                }
                
                // Bone key - unlocks secret in crypt
                if (item === 'bone key' && gameState.currentRoom === 'crypt') {
                    if (!gameState.flags.coffinOpened) {
                        displayMessage('You notice a small bone-shaped keyhole in the largest coffin! You insert the bone key and turn it...', 'warning');
                        displayMessage('<br>The coffin lid slowly creaks open with an ominous grinding sound. Inside, you see nothing but dust and bones.', 'cipher');
                        displayMessage('<br>But wait... as the dust settles, you notice the bottom of the coffin is actually a TRAPDOOR!', 'success');
                        displayMessage('<br>Stone steps lead DOWN into darkness beneath the crypt. A faint green glow emanates from below.', 'warning');
                        displayMessage('<br><span class="success">A hidden passage DOWN has been revealed!</span>', 'success');
                        displayMessage('<br>The fairy dust on the floor seems to sparkle more brightly now, as if reacting to what you\'ve uncovered...', 'cipher');
                        gameState.flags.coffinOpened = true;
                        rooms.crypt.exits.down = 'tomb_of_trials';
                        gameState.secretsFound++;
                        updateStats();
                    } else {
                        displayMessage('The coffin is already open, revealing the passage below.');
                    }
                    return;
                }
                
                if (item === 'bone key') {
                    displayMessage('The bone key is carved from human bone. It probably fits a coffin lock somewhere...');
                    return;
                }
                
                // Holy water - protects in crypt
                if (item === 'holy water' && gameState.currentRoom === 'crypt') {
                    displayMessage('You sprinkle the holy water around you. The air feels cleaner. The spirits seem to retreat. You are protected from some of the crypt\'s dangers!', 'success');
                    gameState.flags['holy_water_used'] = true;
                    gameState.inventory = gameState.inventory.filter(i => i !== 'holy water');
                    updateStats();
                    return;
                }
                
                // Holy water - protects in Tomb of Trials!
                if (item === 'holy water' && gameState.currentRoom === 'tomb_of_trials') {
                    if (!gameState.flags.holyWaterUsed) {
                        displayMessage('You sprinkle the holy water across the floor in a protective circle!', 'success');
                        displayMessage('<br>The blessed liquid sizzles as it touches the cursed ground. The spectral flames dim. The dart launchers freeze in place.', 'success');
                        displayMessage('<br><span class="success">‚ú® HOLY PROTECTION ACTIVE! ‚ú®</span>', 'success');
                        displayMessage('The holy water has neutralized HALF of the tomb\'s deadly traps! But you still need fairy dust for complete safety...', 'warning');
                        gameState.flags.holyWaterUsed = true;
                        gameState.inventory = gameState.inventory.filter(i => i !== 'holy water');
                        updateStats();
                    } else {
                        displayMessage('You\'ve already used the holy water here.');
                    }
                    return;
                }
                
                if (item === 'holy water') {
                    displayMessage('The holy water glows faintly with divine light. It might be useful against undead or cursed places...');
                    return;
                }
                
                // Crown - DEATH TRAP if used before winning
                if (item === 'crown' && gameState.currentRoom !== 'treasure') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You place the crown upon your head. You are no king! The moment it touches your skull, thorns burst inward, impaling your brain from all directions. The crown was cursed to punish the unworthy. Your body convulses as the thorns burrow deeper, shredding your cerebral cortex. You die with the crown fused to your skull, a permanent monument to your hubris. Your corpse will wear this crown forever, a warning to those who would claim power they haven\'t earned.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Don\'t wear the crown outside the treasure room.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (item === 'crown') {
                    displayMessage('The crown glitters with jewels. You\'ve earned this! But... maybe best to keep it in your pack until you leave the dungeon.');
                    return;
                }
                
                // FAIRY DUST - protects in Tomb of Trials!
                if (item === 'fairy dust' && gameState.currentRoom === 'tomb_of_trials') {
                    if (!gameState.flags.fairyDustUsed) {
                        displayMessage('You scatter the shimmering fairy dust into the air!', 'success');
                        displayMessage('<br>The magical particles swirl around you, forming a protective aura. The dust settles on all the pressure plates, neutralizing them.', 'success');
                        displayMessage('<br><span class="success">‚ú® FAIRY PROTECTION ACTIVE! ‚ú®</span>', 'success');
                        if (gameState.flags.holyWaterUsed) {
                            displayMessage('<br><span class="cipher">üõ°Ô∏è COMPLETE PROTECTION ACHIEVED! üõ°Ô∏è</span>', 'cipher');
                            displayMessage('With both holy water AND fairy dust active, you are now SAFE from ALL the tomb\'s traps!', 'success');
                            displayMessage('You can now explore freely and examine the ancient altar cipher without fear!', 'success');
                            rooms.tomb_of_trials.trapsActive = false;
                        } else {
                            displayMessage('The fairy dust has neutralized HALF the traps! But you still need holy water for complete safety...', 'warning');
                        }
                        gameState.flags.fairyDustUsed = true;
                        gameState.inventory = gameState.inventory.filter(i => i !== 'fairy dust');
                        updateStats();
                    } else {
                        displayMessage('You\'ve already used the fairy dust here.');
                    }
                    return;
                }
                
                if (item === 'fairy dust') {
                    displayMessage('The fairy dust sparkles with magical energy. It might neutralize magical traps or curses...');
                    return;
                }
                
                // FLARE - reveals ceiling cipher in Grand Hall
                if (item === 'flare' && gameState.currentRoom === 'hall') {
                    if (!gameState.flags.flareLit) {
                        gameState.flags.flareLit = true;
                        rooms.hall.cipher = 'VWDU KROGV WKH NHBV'; // Reveal the cipher!
                        displayMessage('You ignite the flare! Brilliant red light floods the Grand Hall, illuminating every corner. As the intense light reaches the vaulted ceiling 100 feet above, you gasp in amazement.', 'success');
                        displayMessage('<br>Enormous glowing letters are carved across the stone ceiling, hidden in shadow until now:', 'cipher');
                        displayMessage('<br><span class="cipher">VWDU KROGV WKH NHBV</span>', 'cipher');
                        displayMessage('<br>The flare burns out, but you\'ve seen what was hidden above. You can now SOLVE this cipher!', 'success');
                        gameState.inventory = gameState.inventory.filter(i => i !== 'flare');
                        updateStats();
                    } else {
                        displayMessage('You\'ve already used the flare and seen the ceiling cipher.');
                    }
                    return;
                }
                
                if (item === 'flare' && gameState.currentRoom !== 'hall') {
                    displayMessage('You light the flare, but there\'s nothing special to see here. The flare burns out quickly, wasted.');
                    gameState.inventory = gameState.inventory.filter(i => i !== 'flare');
                    updateStats();
                    return;
                }
                
                // STAR KEY - opens star box
                if (item === 'star key' && gameState.currentRoom === 'star_platform') {
                    if (rooms.star_platform.items.includes('star box')) {
                        displayMessage('You insert the star-shaped key into the center of the celestial box. It fits perfectly!', 'success');
                        displayMessage('The box opens with a harmonic chime, revealing treasures within:', 'success');
                        displayMessage('You obtained: CONSTELLATION MAP and CELESTIAL CIPHER!', 'success');
                        gameState.inventory.push('constellation map');
                        gameState.inventory.push('celestial cipher');
                        gameState.inventory = gameState.inventory.filter(i => i !== 'star key');
                        rooms.star_platform.items = [];
                        gameState.secretsFound++;
                        updateStats();
                    } else {
                        displayMessage('The star box has already been opened.');
                    }
                    return;
                }
                
                if (item === 'star key') {
                    displayMessage('This unique star-shaped key must unlock something special... perhaps a star-shaped box?');
                    return;
                }
                
                // FAIRY WINGS - grants flight ability
                if (item === 'fairy wings') {
                    if (!gameState.flags.wingsEquipped) {
                        gameState.flags.wingsEquipped = true;
                        displayMessage('You carefully unfold the glowing fairy wings and position them against your back. They fuse with your body in a warm surge of ancient magic!', 'success');
                        displayMessage('<br>The wings begin to flutter instinctively, responding to your thoughts. You feel lighter, as if gravity has loosened its grip.', 'success');
                        displayMessage('<br><span class="success">‚ú® NEW ABILITY UNLOCKED: FLIGHT! ‚ú®</span>', 'success');
                        displayMessage('You can now FLY to reach impossible heights and access hidden areas!', 'success');
                    } else {
                        displayMessage('You\'re already wearing the fairy wings.');
                    }
                    return;
                }
                
                // IRON NAIL - useful in armory to disable trap
                if (item === 'iron nail' && gameState.currentRoom === 'armory') {
                    displayMessage('You jam the iron nail into the door mechanism, disabling the trap!', 'success');
                    displayMessage('The concealed scythe trap is now safe. You can examine the armory freely.', 'success');
                    gameState.flags.armoryTrapDisabled = true;
                    gameState.inventory = gameState.inventory.filter(i => i !== 'iron nail');
                    updateStats();
                    return;
                }
                
                // COAL - can be used with torch to create fire in forge
                if (item === 'coal' && gameState.currentRoom === 'forge') {
                    displayMessage('You place the coal in the cold forge and light it with your torch (if you have one).', 'success');
                    if (gameState.inventory.includes('torch')) {
                        displayMessage('The forge roars to life! The room warms. Ancient magic stirs...', 'cipher');
                        displayMessage('A hidden compartment opens, revealing a SECRET RUNE!', 'success');
                        gameState.flags.forgeRulit = true;
                    } else {
                        displayMessage('But you need a torch to light the coal.');
                    }
                    return;
                }
                
                // MOONSTONE - glows in dark places
                if (item === 'moonstone') {
                    displayMessage('The moonstone glows with soft silver light, illuminating your surroundings!', 'success');
                    if (gameState.currentRoom === 'forgotten_chamber' && !gameState.flags.firepitLit) {
                        displayMessage('The moonlight reveals the outline of a firepit you couldn\'t see before!', 'cipher');
                    }
                    return;
                }
                
                // RUNE STONE - activates ancient magic
                if (item === 'rune stone' && gameState.currentRoom === 'entrance') {
                    displayMessage('The rune stone resonates with the archway runes! They glow brighter!', 'success');
                    displayMessage('Ancient knowledge flows into your mind: "The path lies through understanding, not force."', 'cipher');
                    return;
                }
                
                // SOUL STONE - detects undead
                if (item === 'soul stone') {
                    displayMessage('The soul stone pulses, detecting spiritual energy...', 'warning');
                    if (gameState.currentRoom === 'crypt' || gameState.currentRoom === 'tomb_of_trials') {
                        displayMessage('WARNING: Powerful undead presence detected! This area is extremely dangerous!', 'cipher');
                    } else {
                        displayMessage('No undead detected nearby. You are safe... for now.');
                    }
                    return;
                }
                
                // DEATH MASK - can be worn for disguise
                if (item === 'death mask') {
                    displayMessage('You put on the death mask. You feel cold... empty... like you\'re already dead.', 'warning');
                    if (gameState.currentRoom === 'tomb_of_trials') {
                        displayMessage('The spectral flames ignore you! They think you\'re one of the dead!', 'success');
                        gameState.flags.deathMaskWorn = true;
                    } else {
                        displayMessage('Nothing happens. The mask is just creepy.');
                    }
                    return;
                }
                
                // ANCIENT COMPASS - shows direction and hints
                if (item === 'ancient compass') {
                    displayMessage('The ancient compass spins wildly, then points toward...', 'warning');
                    if (!gameState.flags.hall_puzzle_solved) {
                        displayMessage('EAST! It points to the locked door in the Grand Hall!', 'cipher');
                    } else if (gameState.secretsFound < 8) {
                        displayMessage('It spins to multiple directions - secrets remain to be found!', 'warning');
                    } else {
                        displayMessage('NORTH! Toward the treasure room! You have found all secrets!', 'success');
                    }
                    return;
                }
                
                // STARLIGHT SHARD - illuminates darkness
                if (item === 'starlight shard') {
                    displayMessage('The starlight shard blazes with celestial light!', 'success');
                    if (gameState.currentRoom === 'forgotten_chamber') {
                        displayMessage('The radiance reveals EVERYTHING! You see the firepit, the levers, and hidden inscriptions!', 'cipher');
                    } else {
                        displayMessage('The brilliant light illuminates your surroundings beautifully.');
                    }
                    return;
                }
                
                // VOID CRYSTAL - absorbs magic
                if (item === 'void crystal') {
                    displayMessage('The void crystal pulses with dark energy, absorbing ambient magic...', 'warning');
                    if (gameState.currentRoom === 'chamber_of_wonders') {
                        displayMessage('It neutralizes the stasis fields! The floating artifacts drop to the ground!', 'success');
                        displayMessage('WARNING: This might be dangerous!', 'warning');
                    } else {
                        displayMessage('Nothing happens. There\'s no strong magic here to absorb.');
                    }
                    return;
                }
                
                // PRISMATIC GEM - refracts light into ciphers
                if (item === 'prismatic gem' && gameState.inventory.includes('starlight shard')) {
                    displayMessage('You hold the prismatic gem near the starlight shard!', 'success');
                    displayMessage('The light refracts through the gem, projecting a hidden message:', 'cipher');
                    displayMessage('<span class="cipher">THE LIGHT REVEALS TRUTH</span>', 'cipher');
                    return;
                }
                
                displayMessage('You can\'t use that item here.');
                return;
            }
            
            // LIGHT command - for firepit in Forgotten Chamber
            if (command === 'light') {
                if (args.includes('firepit') || args.includes('fire pit')) {
                    if (gameState.currentRoom === 'forgotten_chamber') {
                        if (gameState.inventory.includes('torch')) {
                            if (!gameState.flags.firepitLit) {
                                gameState.flags.firepitLit = true;
                                displayMessage('You touch your torch to the ancient firepit. The wood catches instantly!', 'success');
                                displayMessage('<br>Flames roar to life, casting dancing shadows across the chamber. The sudden light reveals something incredible:', 'success');
                                displayMessage('<br><span class="cipher">ANCIENT FAIRY SCRIPT begins to GLOW on all four walls!</span>', 'cipher');
                                displayMessage('<br>The ethereal blue symbols pulse and shift, forming beautiful patterns. You can now see three ornate levers on the eastern wall, each carved with different fairy runes:', 'success');
                                displayMessage('‚Ä¢ LEVER 1: Carved with symbols of pain and suffering');
                                displayMessage('‚Ä¢ LEVER 2: Carved with symbols of crushing and compression');
                                displayMessage('‚Ä¢ LEVER 3: Carved with symbols of freedom and escape');
                            } else {
                                displayMessage('The firepit is already blazing brightly.');
                            }
                        } else {
                            displayMessage('You need a torch to light the firepit.');
                        }
                    } else {
                        displayMessage('There\'s no firepit here.');
                    }
                    return;
                }
                
                displayMessage('What do you want to light?');
                return;
            }
            
            // PULL command - for levers in Forgotten Chamber
            if (command === 'pull') {
                if (args.includes('lever')) {
                    if (gameState.currentRoom === 'forgotten_chamber') {
                        if (!gameState.flags.firepitLit) {
                            displayMessage('It\'s too dark to see any levers. You need to light the firepit first.', 'warning');
                            return;
                        }
                        
                        if (args.includes('3') || args.includes('three') || args === 'lever3') {
                            displayMessage('You pull the third lever carved with symbols of freedom!', 'success');
                            displayMessage('<br>A grinding sound echoes through the chamber. The floor beneath you trembles...', 'warning');
                            displayMessage('<br>Then a section of floor slides away with a loud CLUNK, revealing stone stairs descending into blue glowing light!', 'success');
                            displayMessage('The fairy script on the walls pulses brighter, as if approving your wise choice.', 'success');
                            displayMessage('<br><span class="success">A path DOWN has been revealed!</span>', 'success');
                            gameState.flags.trapDoorOpen = true;
                            return;
                        }
                        
                        if (args.includes('1') || args.includes('one') || args === 'lever1') {
                            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('üíÄ DEATH üíÄ', 'cipher');
                            displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('<br>' + rooms.forgotten_chamber.deathTriggers['pull lever 1']);
                            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('<span class="warning">YOU HAVE DIED. Choose levers more carefully.</span>');
                            displayMessage('<br>Type "restart" to try again...');
                            gameState.dead = true;
                            return;
                        }
                        
                        if (args.includes('2') || args.includes('two') || args === 'lever2') {
                            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('üíÄ DEATH üíÄ', 'cipher');
                            displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('<br>' + rooms.forgotten_chamber.deathTriggers['pull lever 2']);
                            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('<span class="warning">YOU HAVE DIED. The walls crushed you.</span>');
                            displayMessage('<br>Type "restart" to try again...');
                            gameState.dead = true;
                            return;
                        }
                        
                        displayMessage('Which lever? Specify LEVER 1, LEVER 2, or LEVER 3.');
                    } else {
                        displayMessage('There are no levers here.');
                    }
                    return;
                }
                
                displayMessage('What do you want to pull?');
                return;
            }
            
            // FLY command - use fairy wings to reach high places
            if (command === 'fly') {
                if (gameState.flags.wingsEquipped) {
                    if (gameState.currentRoom === 'ancient_vault') {
                        displayMessage('Your fairy wings beat powerfully! You soar upward toward the impossibly high ceiling.', 'success');
                        displayMessage('<br>As you approach the top, a hidden hatch senses the fairy magic in your wings and opens automatically!', 'success');
                        displayMessage('You fly through into a chamber above...', 'success');
                        // Note: Would need a treasure_vault room added for this to work fully
                        displayMessage('<br>However, that passage seems to be sealed for now. Perhaps more of the dungeon needs to be built first.');
                    } else if (gameState.currentRoom === 'star_platform') {
                        displayMessage('You flutter your wings and hover above the platform briefly, enjoying the sensation of flight. But there\'s nowhere higher to go from here.');
                    } else {
                        displayMessage('You flutter your wings and hover briefly. It\'s an amazing feeling! But there\'s nowhere to fly to in this room.');
                    }
                } else if (gameState.inventory.includes('fairy wings')) {
                    displayMessage('You need to USE the fairy wings first to equip them!');
                } else {
                    displayMessage('You don\'t have wings to fly with.');
                }
                return;
            }
            
            // WEAR command - alternate way to equip wings
            if (command === 'wear') {
                if (args.includes('wing')) {
                    if (gameState.inventory.includes('fairy wings')) {
                        if (!gameState.flags.wingsEquipped) {
                            gameState.flags.wingsEquipped = true;
                            displayMessage('You carefully attach the glowing fairy wings to your back. They fuse with your body in a warm surge of magic!', 'success');
                            displayMessage('The wings begin to flutter instinctively. You feel lighter than air!', 'success');
                            displayMessage('<br><span class="success">‚ú® YOU CAN NOW FLY! ‚ú®</span>', 'success');
                        } else {
                            displayMessage('You\'re already wearing the fairy wings.');
                        }
                    } else {
                        displayMessage('You don\'t have fairy wings.');
                    }
                    return;
                }
                
                displayMessage('What do you want to wear?');
                return;
            }
            
            // FIGHT command - combat system
            if (command === 'fight' || command === 'attack') {
                const enemy = args.toLowerCase();
                
                // Check if player has a weapon
                const weapons = ['rusty sword', 'cursed dagger', 'iron nail'];
                const equippedWeapon = gameState.inventory.find(item => weapons.includes(item));
                
                if (!equippedWeapon) {
                    displayMessage('You have no weapon to fight with! You need a sword, dagger, or similar weapon.', 'warning');
                    return;
                }
                
                // Rusty sword is cursed - using it kills you
                if (equippedWeapon === 'rusty sword') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You swing the rusty sword! The moment you use it in combat, the crimson spores coating the blade explode into the air. The weaponized rust plague fills your lungs. You cough violently as your insides oxidize and corrode. Blood pours from your mouth as your organs liquefy. You collapse, drowning in your own dissolving tissue.', 'warning');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. The rusty sword was cursed!</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Check for specific enemy encounters
                if (gameState.currentRoom === 'fairy_entrance' && enemy.includes('fairy')) {
                    displayMessage('You attack the golden fairy with your ' + equippedWeapon + '!', 'warning');
                    displayMessage('The fairy shrieks and multiplies into a swarm of angry sprites! They surround you, scratching and biting!', 'warning');
                    
                    if (gameState.inventory.includes('fairy dust')) {
                        displayMessage('<br>You quickly scatter the fairy dust! The sprites freeze mid-air, neutralized by their own magic!', 'success');
                        displayMessage('The golden fairy reappears, looking impressed. "You are clever! You may pass freely through my realm."', 'success');
                        gameState.flags.fairyDefeated = true;
                        return;
                    } else {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ DEATH üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<br>Without fairy dust to protect you, the swarm overwhelms you! Thousands of tiny razor-sharp teeth tear into your flesh. You are devoured alive by the fairy swarm, your bones picked clean in seconds.', 'warning');
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. You needed fairy dust to survive fairy combat!</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                }
                
                // Generic combat with no enemy
                displayMessage('There\'s nothing here to fight. Save your strength.');
                return;
            }
            
            // WEAR command - alternate way to equip wings
            if (command === 'wear') {
                if (args.includes('wing')) {
                    if (gameState.inventory.includes('fairy wings')) {
                        if (!gameState.flags.wingsEquipped) {
                            gameState.flags.wingsEquipped = true;
                            displayMessage('You carefully attach the glowing fairy wings to your back. They fuse with your body in a warm surge of magic!', 'success');
                            displayMessage('The wings begin to flutter instinctively. You feel lighter than air!', 'success');
                            displayMessage('<br><span class="success">‚ú® YOU CAN NOW FLY! ‚ú®</span>', 'success');
                        } else {
                            displayMessage('You\'re already wearing the fairy wings.');
                        }
                    } else {
                        displayMessage('You don\'t have fairy wings.');
                    }
                    return;
                }
                
                displayMessage('What do you want to wear?');
                return;
            }
            
            // OPEN command - for star box and ancient box
            if (command === 'open' && args.includes('star box')) {
                if (gameState.currentRoom === 'star_platform') {
                    if (rooms.star_platform.items.includes('star box')) {
                        if (gameState.inventory.includes('star key')) {
                            displayMessage('You insert the star key and turn it. The box opens!', 'success');
                            displayMessage('Inside you find: CONSTELLATION MAP and CELESTIAL CIPHER!', 'success');
                            gameState.inventory.push('constellation map');
                            gameState.inventory.push('celestial cipher');
                            rooms.star_platform.items = [];
                            gameState.secretsFound++;
                            updateStats();
                        } else {
                            displayMessage('The star box is locked. You need a star-shaped key.');
                        }
                    } else {
                        displayMessage('The star box has already been opened.');
                    }
                    return;
                }
            }
            
            if (command === 'open' && (args.includes('ancient box') || args.includes('box'))) {
                if (gameState.currentRoom === 'library') {
                    if (rooms.library.items.includes('ancient box')) {
                        if (gameState.inventory.includes('ancient key')) {
                            displayMessage('You unlock the ancient box with the key. The lid opens to reveal...', 'success');
                            displayMessage('<br>A TRAPDOOR built into the bottom of the box! Stone steps lead down into rainbow light!', 'cipher');
                            displayMessage('<br><span class="success">You can now GO DOWN into the Chamber of Wonders!</span>', 'success');
                            gameState.flags.ancientBoxOpened = true;
                            rooms.library.exits.down = 'chamber_of_wonders';
                            gameState.secretsFound++;
                            updateStats();
                        } else {
                            displayMessage('The ancient box is locked. You need the ancient key.');
                        }
                    } else {
                        displayMessage('The ancient box has already been opened.');
                    }
                    return;
                }
            }

            // Special commands
            if (command === 'open' || command === 'steal' || command === 'desecrate' || command === 'disturb' || 
                command === 'break' || command === 'close' || command === 'burn' || command === 'light') {
                
                // These commands do nothing helpful, just give warnings or flavor text
                if (command === 'open' && args.includes('coffin') && gameState.currentRoom === 'crypt') {
                    displayMessage('You attempt to open one of the coffins. The lid is sealed tight. Perhaps it\'s better left that way...', 'warning');
                    return;
                }
                
                if (command === 'steal' && gameState.currentRoom === 'crypt') {
                    displayMessage('Steal from the dead? You\'re not quite that foolish... yet.', 'warning');
                    return;
                }
                
                if (command === 'desecrate' && gameState.currentRoom === 'crypt') {
                    displayMessage('You consider desecrating the tomb, but something stops you. Perhaps some lines shouldn\'t be crossed.', 'warning');
                    return;
                }
                
                if (command === 'disturb' && gameState.currentRoom === 'crypt') {
                    displayMessage('The dead sleep restlessly here. Best not to disturb them further.', 'warning');
                    return;
                }
                
                if (command === 'light' && !gameState.inventory.includes('torch')) {
                    displayMessage('You have nothing to light.');
                    return;
                }
                
                if (command === 'light' && gameState.inventory.includes('torch')) {
                    displayMessage('Your torch is already lit.');
                    return;
                }
                
                if (command === 'break') {
                    displayMessage('Breaking things won\'t help you here.');
                    return;
                }
                
                if (command === 'close') {
                    displayMessage('There\'s nothing here to close.');
                    return;
                }
                
                if (command === 'burn') {
                    displayMessage('Setting things on fire in a dungeon seems unwise.');
                    return;
                }
                
                displayMessage('That command doesn\'t seem to do anything useful here.');
                return;
            }
            
            if (command === 'wear') {
                const itemName = args.toLowerCase().replace(/ /g, '');
                const item = gameState.inventory.find(i => i.replace(/ /g, '') === itemName);
                
                if (!item) {
                    displayMessage('You don\'t have that item to wear.');
                    return;
                }
                
                // Crown triggers death if worn outside treasure room
                if (item === 'crown' && gameState.currentRoom !== 'treasure') {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You place the crown upon your head. You are no king! The moment it touches your skull, thorns burst inward, impaling your brain from all directions. The crown was cursed to punish the unworthy. Your body convulses as the thorns burrow deeper, shredding your cerebral cortex. You die with the crown fused to your skull, a permanent monument to your hubris. Your corpse will wear this crown forever, a warning to those who would claim power they haven\'t earned.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Don\'t wear the crown outside the treasure room.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (item === 'crown' && gameState.currentRoom === 'treasure') {
                    displayMessage('You place the crown upon your head. It fits perfectly. You have earned this! You are victorious!', 'success');
                    return;
                }
                
                displayMessage('You can\'t wear that.');
                return;
            }
            
            if (command === 'touch') {
                // Touch already handled in death triggers for rooms
                // Add general touch response
                displayMessage('You reach out to touch ' + args + '. Nothing special happens... this time.');
                return;
            }

            if (command === 'say') {
                const words = args.toLowerCase();
                
                // Coffin name curses - only in crypt
                if (gameState.currentRoom === 'crypt') {
                    if (words.includes('malachar')) {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ THE CURSE OF MALACHAR üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<br>You speak the name. MALACHAR.');
                        displayMessage('<br>The coffin lid explodes outward in a shower of stone fragments. From within rises a skeletal figure wrapped in rotting robes, its jaw hanging open in an eternal scream.');
                        displayMessage('<br>"YOU SPOKE MY NAME!" it shrieks, its voice like nails on bone. "YOU HAVE INVOKED THE FORBIDDEN TONGUE!"');
                        displayMessage('<br>Malachar\'s skeletal hands grasp your throat. But he doesn\'t strangle you. Instead, he SPEAKS. Ancient words in a language that predates language itself. Each syllable burns into your mind like acid.');
                        displayMessage('<br>Your tongue begins to move against your will. You are speaking the forbidden words now, repeating his curse. The words tear at your throat from the inside. Blood pours from your mouth as you speak syllables that should not exist.');
                        displayMessage('<br>The curse spreads through your body. Your bones begin to speak in their own voice. Your organs chant in disharmony. Every cell in your body becomes a mouth speaking the forbidden tongue.');
                        displayMessage('<br>Malachar laughs. "Now YOU are the speaker of ruin! Your very existence will curse all who hear you!"');
                        displayMessage('<br>Your body tears itself apart from within, destroyed by the words pouring from every part of you. You die still speaking, still cursing, and your corpse continues to whisper the forbidden tongue for all eternity.');
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. Never speak the names of the cursed dead.</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                    
                    if (words.includes('seraphine')) {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ THE BETRAYAL OF SERAPHINE üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<br>The name leaves your lips. SERAPHINE.');
                        displayMessage('<br>The coffin weeps. Not water - tears of blood that pool on the floor and flow toward you. The lid slides open silently.');
                        displayMessage('<br>She sits up. Beautiful even in death, her face preserved perfectly. She smiles at you with genuine warmth. "Thank you," she whispers. "Thank you for speaking my name. No one has called to me in so long."');
                        displayMessage('<br>You want to help her. She seems so kind, so grateful, so‚Äî');
                        displayMessage('<br>Her hand touches yours. Ice cold.');
                        displayMessage('<br>"I betrayed everyone who ever loved me," she says, still smiling. "My husband. My children. My friends. I sold them all for power I never received. And now... now YOU will understand betrayal."');
                        displayMessage('<br>Your body moves without your permission. Your hands reach for your own throat. "No," you try to say, but you are strangling yourself.');
                        displayMessage('<br>Seraphine\'s curse: you will betray yourself. Your survival instinct turns against you. Your lungs refuse to breathe. Your heart begins to beat backwards. Your brain sends signals to shut down your organs.');
                        displayMessage('<br>"This is what it feels like," she croons, "to be betrayed by what you trust most. Yourself."');
                        displayMessage('<br>You die by your own hand, your body following her command to destroy itself. Seraphine lies back down in her coffin, smiling, waiting for the next fool to speak her name.');
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. The cursed dead hunger for company.</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                    
                    if (words.includes('vortigern')) {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ THE HUNGER OF VORTIGERN üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<br>VORTIGERN. You speak the name of the Flesh-Eater.');
                        displayMessage('<br>The coffin shakes violently. Something inside is HUNGRY. The lid doesn\'t open - it\'s torn off from within by hands that have too many fingers.');
                        displayMessage('<br>What crawls out is barely human. Vortigern is a mass of mouths and teeth, his body twisted by centuries of cannibalistic hunger. Every part of him wants to consume.');
                        displayMessage('<br>"MEAT," he groans. "FRESH MEAT. YOU CALLED ME. YOU ARE MINE."');
                        displayMessage('<br>He moves faster than something dead should move. His mouths bite into you from all angles. But he doesn\'t kill you quickly.');
                        displayMessage('<br>Vortigern eats you slowly. Piece by piece. He starts with your fingers, crunching through bone. Then your toes. Then larger pieces. All while keeping you alive.');
                        displayMessage('<br>"I ate my own children," he says between bites. "I ate my wife. I ate my servants. I ate myself piece by piece until only hunger remained. And hunger... hunger NEVER dies."');
                        displayMessage('<br>He consumes you over hours. Days. Your screams feed him as much as your flesh. When there is almost nothing left of you, he pauses.');
                        displayMessage('<br>"Now," he says, "you will join me. We will be hungry together. Forever."');
                        displayMessage('<br>Your consciousness doesn\'t die. It merges with Vortigern\'s mass of mouths. You become part of him, forever hungry, forever eating, waiting for the next name to be spoken.');
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. The Flesh-Eater\'s hunger is eternal.</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                    
                    if (words.includes('isolde')) {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ THE FLAMES OF ISOLDE üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<br>ISOLDE. The Witch-Queen\'s name echoes in the crypt.');
                        displayMessage('<br>The temperature drops. Then SPIKES. The coffin begins to glow red, then white-hot. It melts into slag.');
                        displayMessage('<br>From the molten metal rises Isolde, wreathed in flames that burn cold and hot simultaneously. Her skin is charred black, but she smiles with teeth made of fire.');
                        displayMessage('<br>"One thousand souls I burned," she says, her voice crackling like a bonfire. "One thousand screaming pyres. And still I hunger for the scent of burning flesh."');
                        displayMessage('<br>She points at you. You ignite.');
                        displayMessage('<br>But this is not normal fire. This is witch-fire, cursed flame that burns the soul before the body. You feel your spirit igniting first, your very essence consumed by impossible heat.');
                        displayMessage('<br>"I burned children," Isolde says, walking around your burning form. "I burned the innocent. I burned those who begged for mercy. And I felt NOTHING but satisfaction."');
                        displayMessage('<br>The flames don\'t kill you. They preserve you in eternal burning. You are a living torch, conscious and aware, feeling every lick of flame for eternity.');
                        displayMessage('<br>"You will burn forever," Isolde whispers. "As I have burned. As all who speak my name must burn. Welcome to my pyre."');
                        displayMessage('<br>She returns to her melted coffin, and you remain standing, burning, screaming silently as flames consume you forever without end.');
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. The Witch-Queen\'s flames are eternal.</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                    
                    if (words.includes('bartholomew')) {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ THE MADNESS OF BARTHOLOMEW üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<br>BARTHOLOMEW. You speak the name of the Mad.');
                        displayMessage('<br>The coffin doesn\'t open. Instead, it begins to laugh. High, keening laughter that splits into harmonics that shouldn\'t exist.');
                        displayMessage('<br>The laughter enters your mind.');
                        displayMessage('<br>Bartholomew the Mad doesn\'t need to leave his coffin. His madness travels through sound, through thought, through the very concept of his name.');
                        displayMessage('<br>Your thoughts begin to fragment. You think in seventeen directions at once. You remember things that never happened. You forget your own name. You understand EVERYTHING and NOTHING simultaneously.');
                        displayMessage('<br>The void that consumed Bartholomew now consumes you. Reality becomes optional. You exist in all states at once - alive, dead, never born, always dying.');
                        displayMessage('<br>"Welcome," says a voice that is your voice but not your voice. "Welcome to the place between thoughts. Where logic dies and madness reigns."');
                        displayMessage('<br>You see colors that don\'t exist. You taste sounds. You smell time. Your body inverts through dimensions that humans can\'t perceive.');
                        displayMessage('<br>Bartholomew appears - not from his coffin, but from inside your mind. He has no face, or infinite faces, or a face that changes with each blink.');
                        displayMessage('<br>"I lost my mind to the void," he giggles. "And now you\'ve lost yours to me. We\'ll be mad together. Forever mad. Madly forever. Forever mad madly mad MAD MAD MAD‚Äî"');
                        displayMessage('<br>Your consciousness shatters into infinite fragments, each one experiencing a different impossible reality. You are everywhere and nowhere. Sane and insane. Dead and undead and never alive.');
                        displayMessage('<br>You have become madness itself.');
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. Or have you? Madness makes death uncertain.</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                }
                
                // Twistedsearch - Alice in Wonderland meets deadly fairies
                if (words.includes('twistedsearch')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DOWN THE RABBIT HOLE üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>The moment you speak those words, the floor beneath you opens - not into darkness, but into LIGHT. Brilliant, impossible light. You fall.');
                    displayMessage('<br>But falling feels like floating. Time stretches like taffy. The walls of the shaft are lined with doors of every size, each one painted in colors that hurt to perceive. You reach for one as you pass. It burns your fingers with cold.');
                    displayMessage('<br>You land softly in a garden where flowers sing and the grass bleeds when walked upon. Everything is too bright, too sharp, too REAL. This is not your dungeon anymore.');
                    displayMessage('<br>A white rabbit in a waistcoat hops past. Its eyes are human. Its teeth are not.');
                    displayMessage('<br>"Late, late, late!" it chitters. "The Queen wants her head! Yours, specifically!"');
                    displayMessage('<br>Before you can respond, the garden shifts. Mushrooms sprout from the ground, growing to impossible heights in seconds. Atop the largest sits a caterpillar with butterfly wings - but the wings are made of EYES, all watching you, all blinking in unison.');
                    displayMessage('<br>"Who... are... YOU?" it asks, smoke curling from its mouth. The smoke forms words in the air: FOOL. LOST. DEAD.');
                    displayMessage('<br>"I\'m just trying to find my way‚Äî" you begin.');
                    displayMessage('<br>"WRONG ANSWER!" shrieks a voice from everywhere and nowhere.');
                    displayMessage('<br>The garden inverts. You are suddenly underwater but still breathing. The Cheshire Cat appears, grin first, then body. But its grin has too many teeth. Far, far too many.');
                    displayMessage('<br>"Did you think this was Wonderland?" it purrs. "Oh no, dear child. This is where Wonderland\'s rejects go. We are the fairies that even the Mad Hatter feared."');
                    displayMessage('<br>The cat\'s grin splits wider, unhinging its jaw. Inside its mouth: another garden, another you, falling again, forever.');
                    displayMessage('<br>You try to run. The playing card soldiers march from behind the roses - but they are not cards. They are paper-thin fairies with razor edges, their faces painted red with the blood of previous guests.');
                    displayMessage('<br>"OFF WITH THEIR HEAD!" roars the Queen. You turn to see her: a massive fairy in a crown of bone, her dress made of still-beating hearts, her scepter a spine that still screams.');
                    displayMessage('<br>"But I haven\'t done anything wrong!" you protest.');
                    displayMessage('<br>The Queen leans close. Her breath smells of burnt sugar and rotting flowers. "You SPOKE the forbidden search. You WANTED to find us. Well, congratulations, Alice. You found us."');
                    displayMessage('<br>"I\'m not Alice‚Äî"');
                    displayMessage('<br>"EVERYONE here is Alice eventually," she cackles. "And everyone here LOSES THEIR HEAD!"');
                    displayMessage('<br>The card soldiers grab you. Their edges slice your skin with every touch. They drag you to a table set for tea - but the tea is boiling blood, and the sandwiches are filled with crushed glass.');
                    displayMessage('<br>The Mad Hatter sits at the head, his hat made of vertebrae, his smile stitched permanently across his face with wire. "TEA TIME!" he shrieks. "Drink! DRINK! It\'s always tea time in hell!"');
                    displayMessage('<br>They force the scalding liquid down your throat. Your insides blister and burn. The March Hare appears - but it\'s a grotesque thing of too many limbs and too many heads, each one giggling in a different pitch.');
                    displayMessage('<br>"Change places!" they all scream. "CHANGE PLACES!"');
                    displayMessage('<br>Your body begins to shift. Your arms elongate like the White Rabbit\'s. Your smile stretches like the Cheshire Cat\'s. Your heart becomes a playing card, thin and fragile and marked with the Queen\'s seal.');
                    displayMessage('<br>You are becoming part of Wonderland. The twisted, fairy-infested, nightmare Wonderland where nothing makes sense and pain is the only constant.');
                    displayMessage('<br>The Queen picks up an axe made of crystallized moonlight. "We don\'t actually remove heads here," she says sweetly. "We remove SELVES. Piece by piece. Thought by thought. Until you\'re just another character in my garden, forever playing your part."');
                    displayMessage('<br>The axe falls. But it doesn\'t kill. It TRANSFORMS. Your legs become roots, sinking into the bleeding grass. Your arms become branches, reaching toward a sky that isn\'t there. Your screams become the song of flowers.');
                    displayMessage('<br>You are a tree now. A thinking, feeling, conscious tree in the Queen\'s garden. Visitors will walk past you. Sit beneath your shade. Carve their names into your bark - and you will FEEL every cut.');
                    displayMessage('<br>The Cheshire Cat appears one last time, grin floating beside your trunk. "Curiouser and curiouser," it whispers. "You wanted to search for something twisted. Well... you found yourself."');
                    displayMessage('<br>And there you stay. Forever. A tree that was once human. Forever awake. Forever aware. Forever part of the mad fairy garden that exists beyond the looking glass.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Some searches lead to places where madness and cruelty dance together in eternal tea parties.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // 12345 - The Combination Death
                if (words.includes('12345')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ THE COMBINATION üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You speak the numbers aloud. One. Two. Three. Four. Five.');
                    displayMessage('<br>The dungeon trembles.');
                    displayMessage('<br>Somewhere deep beneath you, ancient mechanisms begin to turn. Gears that have not moved in ten thousand years grind to life. The sound is deafening - metal shrieking against metal, stone grinding against stone.');
                    displayMessage('<br>You have spoken the forbidden combination. The original code. The sequence that was never meant to be uttered again.');
                    displayMessage('<br>The walls split open, revealing countless doors. Hundreds. Thousands. Each one unlocking simultaneously. Behind every door: a prisoner. Not human prisoners. Things that were locked away when the world was young. Things that gods themselves feared to name.');
                    displayMessage('<br>The first door opens. Out steps a creature made entirely of hands - grasping, clutching, strangling hands with no body to support them. It sees you and SCREAMS with a mouth it does not have.');
                    displayMessage('<br>The second door opens. A shadow pours out like oil, but the shadow has teeth. It flows toward you, hungry after eons of starvation.');
                    displayMessage('<br>The third door. The fourth. The fifth. They open faster now.');
                    displayMessage('<br>A thing that is all eyes and no pupils. A creature that exists backwards in time, killing you before it reaches you. A mass of flesh that was once a civilization. A sound given form. A concept made manifest.');
                    displayMessage('<br>"YOU SPOKE THE COMBINATION!" they shriek in unison. "YOU FREED US ALL!"');
                    displayMessage('<br>They do not kill you quickly.');
                    displayMessage('<br>The hand-creature takes your fingers first, one by one, adding them to its collection. The shadow-with-teeth drinks your screams. The flesh-mass absorbs you slowly, and you feel yourself becoming part of its horrible consciousness - joining the millions of souls already trapped within.');
                    displayMessage('<br>But worse than the physical pain is the knowledge: You are the fool who spoke 12345. The simplest combination. The most obvious sequence. And in your stupidity, you have unleashed horrors beyond comprehension upon the world.');
                    displayMessage('<br>The last thing you hear before your mind shatters completely is the dungeon keeper\'s voice, ancient and bitter: "We locked them away for a REASON. We made the combination SIMPLE so no one would be STUPID enough to say it aloud. But you... you just HAD to speak the numbers, didn\'t you?"');
                    displayMessage('<br>The creatures tear you apart across multiple dimensions. Your death takes centuries from your perspective. Your body is used as a key - your bones ground into powder that opens even MORE doors, your blood used to oil locks that should have stayed rusted shut, your screams converted into sonic keys that release things that should not be released.');
                    displayMessage('<br>When it is finally over - when there is nothing left of you to torture - the dungeon reassembles you just enough to be conscious. You exist now as a warning carved into the walls: "HERE DIED THE FOOL WHO SAID 12345."');
                    displayMessage('<br>And somewhere in the darkness, all the creatures you freed are laughing.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. The combination was a lock for a reason. Some sequences should never be spoken.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Twisted Wings - triggered by buttcheeks
                if (words.includes('buttcheeks')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ TWISTED WINGS üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>The moment you speak those words, the dungeon changes. The stone walls fade. Trees materialize around you‚Äîancient, silent trees. The dungeon has become a forest, and the forest goes quiet. Not suddenly‚Äînever suddenly. The torches do not flicker. The shadows do not move. Silence makes room for her.');
                    displayMessage('<br>Twisted Wings drifts between the trees like a blessing you didn\'t know you needed.');
                    displayMessage('<br>Her wings shimmer‚Äîopalescent, gossamer, soft as breath. They look damaged at first glance, bent at strange angles, veins catching the light wrong. But when she turns, you see it isn\'t damage at all. It\'s design. Intentional. Perfect.');
                    displayMessage('<br>She smiles.');
                    displayMessage('<br>Everyone remembers the smile.');
                    displayMessage('<br>It is warm. Gentle. Grateful. The smile of someone relieved you finally arrived.');
                    displayMessage('<br>"You look tired," she says. "This place takes so much from travelers."');
                    displayMessage('<br>Her voice smooths the ache in your chest. Your grip loosens. Your heartbeat slows to match the glow pulsing beneath her skin.');
                    displayMessage('<br>She offers her hand.');
                    displayMessage('<br>The forest brightens.');
                    displayMessage('<br>Flowers open that were never there before. Light bends toward her like it wants her approval. You feel chosen‚Äîseen in a way the world outside never managed.');
                    displayMessage('<br>"I protect those who trust me," she whispers. "I only punish what means harm."');
                    displayMessage('<br>There is no lie in her voice. That\'s the first warning.');
                    displayMessage('<br>You cannot help but accept her hand. Her fingers are cold.');
                    displayMessage('<br>Not dead-cold. Not yet. Just cold enough to remind you that warmth must be taken from somewhere else.');
                    displayMessage('<br>Her wings unfurl.');
                    displayMessage('<br>Up close, you see the truth: Each feather ends in a blade so thin it doesn\'t reflect light. The veins pulse like something feeding. The glow you admired is not magic‚Äîit is consumption.');
                    displayMessage('<br>She does not attack.');
                    displayMessage('<br>She embraces.');
                    displayMessage('<br>Twisted Wings wraps herself around you, wings folding inward like closing doors. The forest goes silent again‚Äînot peaceful this time. Expectant.');
                    displayMessage('<br>"Thank you," she breathes, forehead against yours. "You believed."');
                    displayMessage('<br>The blades pass through without pain. That comes later, if at all. What she takes first is not blood.');
                    displayMessage('<br>It\'s momentum. Choice. The part of you that still thought this would end differently.');
                    displayMessage('<br>Your vision fills with light. Then white. Then nothing.');
                    displayMessage('<br>"Beauty is how I feed," she says. "Kindness is how I\'m allowed close."');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. A single feather remains‚Äîcurved, flawless, sharp enough to draw blood. Somewhere, unseen, she smiles again‚Äîalready waiting for the next one who mistakes gentleness for safety.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Deadly trigger words
                if (words.includes('help') || words.includes('assist') || words.includes('aid')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>The moment you cry out for help, the dungeon responds. But not with salvation. The walls begin to weep blood, and from the crimson tears emerge thousands of spectral hands. They are the hands of every adventurer who died here before you, all reaching, grasping, desperate. "YOU CALLED FOR HELP?" they wail in chorus. "WE CALLED TOO! NO ONE CAME!" The hands grab you from all directions, pulling you in different directions simultaneously. Your joints dislocate, your muscles tear, your bones crack. "Join us!" they shriek. "Join us in eternal helplessness!" You are torn apart piece by piece, your screams adding to the chorus of the damned. Your spirit joins the wall of hands, forever reaching out, forever crying for help that will never come. The next adventurer who calls for aid will feel YOUR hand among the thousands.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Never cry for help in a cursed dungeon.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (words.includes('surrender') || words.includes('give up') || words.includes('quit')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>The words leave your mouth and hang in the air like ice. The dungeon itself seems to pause, listening. Then, with terrible finality, it ACCEPTS your surrender. The floor opens beneath you, revealing not a pit but a mouth - the dungeon itself is alive and you have just offered yourself as food. Thousands of stone teeth rise from the depths. "We accept your surrender," rumbles a voice older than civilization. "Your will is ours. Your hope is forfeit. Your struggle ends." You try to take it back, to fight, but you SAID the words. The binding is complete. The mouth closes slowly, savoring your terror. The teeth don\'t bite - they don\'t need to. You simply cease to exist, unmade by your own declaration of defeat. Your name is erased from history. Your deeds are forgotten. You never were. Somewhere, someone who loved you forgets why they feel sad today.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Never surrender to the dungeon.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (words.includes('afraid') || words.includes('scared') || words.includes('fear')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You speak your fear aloud. MISTAKE. Fear is a living thing in this dungeon, and you have just fed it your admission. From the shadows emerges your fear made manifest - a towering entity composed of every nightmare you\'ve ever had. It wears the face of your childhood terrors, the voice of your deepest anxieties, the form of your secret dreads. "Thank you," it whispers in the voice of everyone who ever disappointed you, "for naming me. For giving me power." Your fear wraps around you like chains. You cannot move, cannot fight, cannot even scream. The entity feeds on you slowly, drinking your courage first, then your hope, then your will to live. By the time it reaches your soul, you are begging for death. But death is too kind. Instead, you become part of IT, absorbed into the living embodiment of terror. Now you are the nightmare that hunts other adventurers. You are the thing that makes brave warriors weep. You are fear itself, and you will exist in this state until the sun dies and the stars go cold.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Never speak your fear in darkness.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (words.includes('god') || words.includes('devil') || words.includes('demon')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You invoke higher powers. They hear you. And they are ANGRY at being summoned to this forsaken place. A rift tears open in reality itself. From beyond the veil comes something vast and terrible - not god, not devil, but something that exists in the spaces between divine and profane. It has too many eyes. It has mouths where mouths should not be. It exists in dimensions your mind cannot process. "YOU DARE SPEAK OUR NAMES?" it roars in a voice that shatters your sanity. Your mind breaks first, fragmenting into a thousand screaming pieces. Then your body follows - not destroyed, but REORGANIZED into a form that better pleases this entity. You are turned inside out, your organs on the outside, your skin on the inside. But you remain conscious. You remain aware. You remain ALIVE in this new, impossible configuration. The entity leaves you this way as a warning to others: do not invoke the names of powers beyond mortal ken. You will exist in this agonizing state for eternity, unable to die, unable to heal, a monument to blasphemous hubris.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Never invoke divine names in cursed places.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (words.includes('love') || words.includes('friend') || words.includes('family')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You speak of love in a place that knows only hate. You speak of connection in a place of isolation. The dungeon cannot abide this. From the darkness come phantoms wearing the faces of everyone you\'ve ever loved. Your mother, your father, your friends, your beloved - all here, all smiling. "We came for you," they say sweetly. You run to embrace them. Their arms close around you. Then the arms become TIGHT. Too tight. They are crushing you. "We love you SO MUCH," they croon as your ribs crack, "that we will NEVER let you go." Their faces melt away, revealing rotting corpses beneath. These are not your loved ones - they are mockeries, puppets made from your memories. They crush you slowly, lovingly, whispering sweet nothings as your bones splinter and your organs rupture. "This is what love means here," they giggle. "Forever together. Forever one." They don\'t stop crushing until you are pulp. Then they absorb you into themselves, and you become part of the puppet show, waiting to embrace the next fool who speaks of love in this loveless place.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Love has no power here.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (words.includes('mercy') || words.includes('please') || words.includes('spare')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You beg for mercy. The dungeon laughs. It is not a sound meant for human ears - it is the grinding of continental plates, the screaming of dying stars, the weeping of murdered worlds. "Mercy?" it asks in a voice made of pain. "Let me SHOW you mercy." You are transported instantly to a chamber you did not know existed. In it are all the adventurers who came before you, still alive, all begging for mercy. They have been here for centuries, kept alive by dark magic, their bodies broken and reformed in endless cycles of torture. "Welcome," they moan. "Welcome to the Mercy Chamber." Here, you will be granted mercy - you will not die. You will BEG to die, you will PRAY for death, but death will never come. The dungeon will break every bone in your body, then heal you and do it again. It will burn you alive, then restore you and burn you again. It will drown you in acid for decades. It will feed you to things with teeth. And every time you break, it will whisper: "This is mercy. You asked for mercy. I am being MERCIFUL." After the first thousand years, you will forget your name. After ten thousand, you will forget you were ever human. But you will never, ever die.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. The dungeon\'s mercy is more terrible than its wrath.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                if (words.includes('treasure') || words.includes('gold') || words.includes('rich')) {
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('üíÄ DEATH üíÄ', 'cipher');
                    displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<br>You speak of treasure with greed in your voice. The dungeon hears. It understands. It provides. The walls begin to weep gold - liquid, molten gold pours from every crack and crevice. "You want treasure?" whispers the dungeon. "TAKE IT. TAKE IT ALL." You try to run but the gold flows faster, a flood of liquid metal. It catches your feet first, hardening instantly around your ankles. You fall, and more gold washes over you. It fills your mouth when you scream. It pours into your nose, your eyes, your ears. It seeps into your pores. You are being GILDED alive, transformed into a golden statue. But you remain conscious. You remain aware. Entombed in gold, you cannot move, cannot breathe, cannot die. The gold preserves you perfectly. You will stand here for eternity, a golden monument to greed, still conscious, still aware, still screaming silently inside your prison of precious metal. Adventurers who find you will marvel at the beautiful golden statue. They will never know it screams.');
                    displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                    displayMessage('<span class="warning">YOU HAVE DIED. Greed is its own punishment.</span>');
                    displayMessage('<br>Type "restart" to try again...');
                    gameState.dead = true;
                    return;
                }
                
                // Safe to say
                displayMessage(`You say: "${args}"`);
                displayMessage('Your words echo in the darkness, then fade. Nothing happens... this time.');
                return;
            }

            if (command === 'take') {
                // Handle "take all"
                if (args === 'all') {
                    if (!room.items || room.items.length === 0) {
                        displayMessage('There\'s nothing here to take.');
                        return;
                    }
                    
                    const itemCount = room.items.length;
                    room.items.forEach(item => {
                        gameState.inventory.push(item);
                    });
                    displayMessage(`You take everything: ${room.items.join(', ')}`, 'success');
                    room.items = [];
                    updateStats();
                    return;
                }
                
                const itemName = args.toLowerCase();
                const itemKey = itemName.replace(/ /g, '');
                
                // Check if item exists in room
                if (room.items && room.items.some(item => item.replace(/ /g, '') === itemKey)) {
                    const actualItem = room.items.find(item => item.replace(/ /g, '') === itemKey);
                    gameState.inventory.push(actualItem);
                    room.items = room.items.filter(item => item !== actualItem);
                    displayMessage(`You take the ${actualItem}.`, 'success');
                    updateStats();
                } else {
                    displayMessage(`You can't take that.`);
                }
                return;
            }

            if (command === 'solve') {
                const answer = args.toUpperCase().replace(/\s/g, '');
                
                // Check cipher solutions
                if (room.cipher && !gameState.flags[`${gameState.currentRoom}_cipher_solved`]) {
                    if (answer === room.cipherSolution.replace(/\s/g, '')) {
                        displayMessage(`‚ú® Correct! You have decoded the cipher!`, 'success');
                        gameState.secretsFound++;
                        gameState.flags[`${gameState.currentRoom}_cipher_solved`] = true;
                        
                        // Give a clue about the final password
                        const clueIndex = gameState.secretsFound - 1;
                        if (clueIndex < gameState.finalPassword.clues.length) {
                            const clue = gameState.finalPassword.clues[clueIndex];
                            gameState.cluesReceived.push(clue);
                            displayMessage(`<br>üîÆ A vision flashes before you...`, 'warning');
                            displayMessage(`<span class="success">"${clue}"</span>`);
                            displayMessage(`<br>This clue may help you discover the FINAL PASSWORD.`);
                        }
                        
                        updateStats();
                        
                        if (gameState.currentRoom === 'entrance') {
                            displayMessage('<br>The runes glow brightly and you feel wiser.');
                        } else if (gameState.currentRoom === 'library') {
                            displayMessage('<br>The book reveals ancient knowledge!');
                        } else if (gameState.currentRoom === 'armory') {
                            displayMessage('<br>The shield gleams with newfound power!');
                        } else if (gameState.currentRoom === 'forge') {
                            displayMessage('<br>The tablet crumbles to dust, its secret revealed!');
                        } else if (gameState.currentRoom === 'hall') {
                            displayMessage('<br>The ceiling cipher fades, but its truth remains in your mind!');
                        } else if (gameState.currentRoom === 'hidden_sanctum') {
                            displayMessage('<br>The fairy skeleton seems to smile. The wings pulse with brighter light!');
                        } else if (gameState.currentRoom === 'chamber_of_wonders') {
                            displayMessage('<br>The crystal obelisk glows brilliantly! The floating artifacts spin faster in celebration!');
                        } else if (gameState.currentRoom === 'tomb_of_trials') {
                            displayMessage('<br>The altar rumbles and the spectral flames turn from green to peaceful blue. Ancient knowledge fills your mind!');
                        }
                        return;
                    } else {
                        displayMessage('That is not the correct solution.', 'warning');
                        return;
                    }
                }
                
                // Check puzzle solutions
                if (room.puzzle && !gameState.flags[`${gameState.currentRoom}_puzzle_solved`]) {
                    if (gameState.currentRoom === 'hall' && answer === room.puzzleSolution) {
                        displayMessage('‚ú® The door clicks open! The puzzle is solved!', 'success');
                        gameState.secretsFound++;
                        gameState.flags[`${gameState.currentRoom}_puzzle_solved`] = true;
                        
                        // Give a clue about the final password
                        const clueIndex = gameState.secretsFound - 1;
                        if (clueIndex < gameState.finalPassword.clues.length) {
                            const clue = gameState.finalPassword.clues[clueIndex];
                            gameState.cluesReceived.push(clue);
                            displayMessage(`<br>üîÆ A vision flashes before you...`, 'warning');
                            displayMessage(`<span class="success">"${clue}"</span>`);
                            displayMessage(`<br>This clue may help you discover the FINAL PASSWORD.`);
                        }
                        
                        updateStats();
                        return;
                    }
                }
                
                // Final password check
                if (gameState.currentRoom === 'crypt' && room.puzzle) {
                    if (gameState.secretsFound < 8) {
                        displayMessage(`You need all 8 secrets before attempting the final password. You have ${gameState.secretsFound}/8.`, 'warning');
                        return;
                    }
                    
                    if (answer === gameState.finalPassword.word) {
                        displayMessage(`üéä The final password "${gameState.finalPassword.word}" is correct! The massive door swings open!`, 'success');
                        gameState.flags['crypt_puzzle_solved'] = true;
                        displayMessage(`You may now go north to the treasure chamber!`);
                        return;
                    } else {
                        displayMessage(`That is not the correct final password. Review your clues carefully...`, 'warning');
                        return;
                    }
                }
                
                displayMessage('There is nothing here to solve right now.');
                return;
            }

            if (command === 'go') {
                const direction = args;
                
                if (room.exits[direction]) {
                    const nextRoom = room.exits[direction];
                    
                    // Special checks
                    if (gameState.currentRoom === 'entrance' && direction === 'north' && !gameState.inventory.includes('torch')) {
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('üíÄ DEATH üíÄ', 'cipher');
                        displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<br>You step into the hall without a light source. The darkness is absolute, suffocating. You hear chittering, skittering sounds all around you. Something ancient and hungry has lived in this darkness for centuries, waiting for fools who enter unprepared. Thousands of dungeon beetles swarm over your body, each one the size of a fist. They devour you alive in the pitch black. Your screams echo through the hall as they strip the flesh from your bones. You die in agony, never seeing what killed you, your skeleton picked clean in minutes.');
                        displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                        displayMessage('<span class="warning">YOU HAVE DIED. Always bring a torch into darkness.</span>');
                        displayMessage('<br>Type "restart" to try again...');
                        gameState.dead = true;
                        return;
                    }
                    
                    if (gameState.currentRoom === 'hall' && direction === 'east' && !gameState.flags['hall_puzzle_solved']) {
                        displayMessage('The door is locked. You must solve the puzzle first.', 'warning');
                        return;
                    }
                    
                    if (gameState.currentRoom === 'library' && direction === 'down') {
                        // Check if going to chamber_of_wonders (ancient box) or crypt (cipher)
                        if (rooms.library.exits.down === 'chamber_of_wonders' && !gameState.flags.ancientBoxOpened) {
                            displayMessage('The ancient box is closed. You need to open it first.', 'warning');
                            return;
                        }
                        if (rooms.library.exits.down === 'crypt' && !gameState.flags['library_cipher_solved']) {
                            displayMessage('You don\'t see any way down. Perhaps you need to solve the cipher first?', 'warning');
                            return;
                        }
                    }
                    
                    if (gameState.currentRoom === 'crypt' && direction === 'north' && !gameState.flags['crypt_puzzle_solved']) {
                        displayMessage('The massive door is sealed tight. You need the final password.', 'warning');
                        return;
                    }
                    
                    // New room checks
                    if (gameState.currentRoom === 'entrance' && direction === 'up') {
                        if (!gameState.inventory.includes('rope')) {
                            displayMessage('You need a ROPE to climb up to the elevated platform.', 'warning');
                            return;
                        }
                        if (!gameState.inventory.includes('torch')) {
                            displayMessage('It\'s too dark up there. You need a TORCH to see where you\'re climbing.', 'warning');
                            return;
                        }
                    }
                    
                    if (gameState.currentRoom === 'hall' && direction === 'southwest') {
                        if (!gameState.inventory.includes('torch')) {
                            displayMessage('That passage is pitch black. You need a torch to see where you\'re going.', 'warning');
                            return;
                        }
                    }
                    
                    if (gameState.currentRoom === 'forgotten_chamber' && direction === 'down' && !gameState.flags.trapDoorOpen) {
                        displayMessage('There\'s no way down. The floor is solid stone.', 'warning');
                        return;
                    }
                    
                    gameState.currentRoom = nextRoom;
                    displayMessage('<br>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
                    describeRoom();
                    updateStats();
                    
                    // Check for auto-death rooms (fairy maze dead ends)
                    if (rooms[nextRoom].autoDeath) {
                        setTimeout(() => {
                            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('üíÄ DEATH üíÄ', 'cipher');
                            displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage(`<br>${rooms[nextRoom].autoDeath}`);
                            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                            displayMessage('<span class="warning">YOU HAVE DIED. The fairies laugh at your foolishness.</span>');
                            displayMessage('<br>Type "restart" to try again, if you dare face their mockery once more...');
                            gameState.dead = true;
                        }, 1000);
                    }
                    
                    // Check for Tomb of Trials trap activation
                    if (nextRoom === 'tomb_of_trials' && rooms.tomb_of_trials.trapsActive) {
                        setTimeout(() => {
                            if (!gameState.flags.holyWaterUsed || !gameState.flags.fairyDustUsed) {
                                displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                                displayMessage('üíÄ DEATH üíÄ', 'cipher');
                                displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                                displayMessage('<br>The moment you step into the tomb, you trigger EVERY TRAP AT ONCE!', 'warning');
                                displayMessage('<br>Without BOTH holy water AND fairy dust protection, the deadly traps activate:', 'warning');
                                displayMessage('<br>Poisoned darts fire from all directions. Pressure plates explode. Spectral flames erupt from the braziers. The skulls scream in a cacophony of torment.', 'warning');
                                displayMessage('<br>You are impaled by hundreds of projectiles, burned by soul-fire, and deafened by the screaming of the damned. Your body is destroyed so completely that only dust remains.', 'warning');
                                displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
                                displayMessage('<span class="warning">YOU HAVE DIED. You needed BOTH holy water AND fairy dust from the crypt to survive!</span>');
                                displayMessage('<br>Type "restart" to try again...');
                                gameState.dead = true;
                            }
                        }, 1500);
                    }
                } else {
                    displayMessage('You cannot go that way.');
                }
                return;
            }

            displayMessage('I don\'t understand that command. Type "help" for a list of commands.');
        }

        function submitCommand() {
            const input = document.getElementById('command-input');
            const command = input.value.trim();
            
            if (command === '') return;
            
            displayMessage(`<br>> ${command}`, 'warning');
            processCommand(command);
            
            input.value = '';
        }

        document.getElementById('command-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitCommand();
            }
        });

        // Initialize game
        displayMessage('üóùÔ∏è Welcome to the Cryptic Dungeon! üóùÔ∏è');
        displayMessage('A dark fantasy puzzle adventure awaits...');
        displayMessage('<br><span class="warning">‚ö†Ô∏è WARNING: Make choices carefully. Death is permanent and lurks in every shadow.</span>');
        displayMessage('<br>Type "help" to see available commands.');
        describeRoom();
        updateStats();
        
        // Anti-cheat detection - multiple methods
        let devtoolsOpen = false;
        let consoleCheckInterval;
        let antiCheatActive = false;
        
        // Delay anti-cheat activation by 3 seconds to avoid false positives on load
        setTimeout(() => {
            antiCheatActive = true;
        }, 3000);
        
        // Method 1: Window size detection
        const detectDevTools = () => {
            if (!antiCheatActive) return;
            
            const threshold = 160;
            const widthThreshold = window.outerWidth - window.innerWidth > threshold;
            const heightThreshold = window.outerHeight - window.innerHeight > threshold;
            const orientation = widthThreshold ? 'vertical' : 'horizontal';
            
            if ((heightThreshold && orientation === 'horizontal') || 
                (widthThreshold && orientation === 'vertical')) {
                if (!devtoolsOpen && !gameState.dead) {
                    devtoolsOpen = true;
                    triggerCheaterDeath();
                }
            }
        };
        
        // Method 2: Console.log override (delayed activation)
        const originalLog = console.log;
        let consoleUsed = false;
        
        const checkConsoleLog = console.log;
        console.log = function() {
            if (antiCheatActive && !consoleUsed && !gameState.dead) {
                consoleUsed = true;
                setTimeout(() => {
                    if (!devtoolsOpen) {
                        devtoolsOpen = true;
                        triggerCheaterDeath();
                    }
                }, 100);
            }
            return originalLog.apply(console, arguments);
        };
        
        function triggerCheaterDeath() {
            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
            displayMessage('üíÄ CHEATER\'S DEATH üíÄ', 'cipher');
            displayMessage('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
            displayMessage('<br>The dungeon senses your treachery. You have attempted to peer beyond the veil, to see what mortals should not see. The walls begin to bleed reality itself.');
            displayMessage('<br>A voice booms from everywhere and nowhere: "YOU DARE TRY TO CHEAT DEATH?"');
            displayMessage('<br>The console you opened becomes a portal. From it crawls something that exists outside the game, outside reality itself. It is the Meta-Horror, the thing that punishes those who break the fourth wall.');
            displayMessage('<br>It has no form your mind can process. It exists in the code itself, in the spaces between 1 and 0. And it is ANGRY.');
            displayMessage('<br>"You wanted to see the source?" it hisses in a voice made of corrupted data. "Let me show you what happens when you look too deep."');
            displayMessage('<br>Your character\'s code begins to unravel. Your inventory deletes itself. Your stats corrupt. Your very existence in the game world starts to fragment.');
            displayMessage('<br>But worse - the Meta-Horror reaches through the screen. You feel it. Not your character. YOU. The player. It knows you opened the console. It knows you tried to cheat.');
            displayMessage('<br>Your character explodes into pixels. But you remain conscious, trapped in the void between code and reality. The Meta-Horror\'s laughter echoes in frequencies that hurt: "Cheaters never prosper. Cheaters never escape. Cheaters never WIN."');
            displayMessage('<br>The game crashes. Or does it? You restart, but something feels wrong. Are you playing the game, or is the game playing you?');
            displayMessage('<br>‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'warning');
            displayMessage('<span class="warning">YOU HAVE DIED. The dungeon does not forgive cheaters. Close the console and restart to play fairly.</span>');
            displayMessage('<br>Type "restart" to try again... if you dare.');
            gameState.dead = true;
            gameState.inventory = [];
            gameState.secretsFound = 0;
            gameState.cluesReceived = [];
            updateStats();
            if (consoleCheckInterval) clearInterval(consoleCheckInterval);
        }
        
        // Check every 500ms (after delay)
        consoleCheckInterval = setInterval(() => {
            if (!gameState.dead && antiCheatActive) {
                detectDevTools();
            }
        }, 500);
        
        // Detect right-click attempt to inspect
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            if (!gameState.dead && antiCheatActive) {
                displayMessage('<br><span class="warning">‚ö†Ô∏è The dungeon whispers: "Trying to inspect? Tread carefully, cheater..."</span>');
            }
        });
        
        // Detect F12 key and common devtools shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12' || 
                (e.ctrlKey && e.shiftKey && e.key === 'I') ||
                (e.ctrlKey && e.shiftKey && e.key === 'J') ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                if (!gameState.dead && antiCheatActive) {
                    displayMessage('<br><span class="warning">‚ö†Ô∏è The dungeon blocks your attempt. Play fair or face the consequences...</span>');
                }
            }
        });
    </script>
</body>
</html>
